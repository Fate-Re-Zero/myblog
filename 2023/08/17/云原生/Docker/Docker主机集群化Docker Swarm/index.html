<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="一、docker swarm介绍Docker Swarm是Docker官方提供的一款集群管理工具，其主要作用是把若干台Docker主机抽象为一个整体，并且通过一个入口统一管理这些Docker主机上的各种Docker资源。Swarm和Kubernetes比较类似，但是更加轻，具有的功能也较kubernetes更少一些。  是docker host集群管理工具 docker官方提供的 docker 1">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker主机集群化方案Docker Swarm">
<meta property="og:url" content="https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/index.html">
<meta property="og:site_name" content="祥祥要起飞">
<meta property="og:description" content="一、docker swarm介绍Docker Swarm是Docker官方提供的一款集群管理工具，其主要作用是把若干台Docker主机抽象为一个整体，并且通过一个入口统一管理这些Docker主机上的各种Docker资源。Swarm和Kubernetes比较类似，但是更加轻，具有的功能也较kubernetes更少一些。  是docker host集群管理工具 docker官方提供的 docker 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216093807929.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216093706989.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216111914692.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216163257339.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216174612048.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216222436884.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/ingress-routing-mesh.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102033645.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102606092.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102654303.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217120725646.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217120746215.png">
<meta property="article:published_time" content="2023-08-17T00:48:22.000Z">
<meta property="article:modified_time" content="2025-04-23T15:57:45.687Z">
<meta property="article:author" content="祥祥要起飞">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fate-re-zero.github.io/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216093807929.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Docker主机集群化方案Docker Swarm</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="祥祥要起飞" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2023/08/25/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/%E5%9F%BA%E4%BA%8EDocker%E5%AE%B9%E5%99%A8DevOps%E5%BA%94%E7%94%A8%E6%96%B9%E6%A1%88/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2023/08/13/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E5%AE%B9%E5%99%A8%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%88%A9%E5%99%A8Docker%20Compose/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&text=Docker主机集群化方案Docker Swarm"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&is_video=false&description=Docker主机集群化方案Docker Swarm"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker主机集群化方案Docker Swarm&body=Check out this article: https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&name=Docker主机集群化方案Docker Swarm&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81docker-swarm%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">一、docker swarm介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81docker-swarm%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">二、docker swarm概念与架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 概念</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81docker-swarm%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">三、docker swarm集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Harbor%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 容器镜像仓库 Harbor准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%B8%BB%E6%9C%BA%E5%87%86%E5%A4%87"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 主机准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 主机名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-IP%E5%9C%B0%E5%9D%80"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 IP地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%B8%8EIP%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 主机名与IP地址解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E4%B8%BB%E6%9C%BA%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.3.4 主机时间同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.2.5 主机安全设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 docker安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.3.1 docker安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E9%85%8D%E7%BD%AEdocker-daemon%E4%BD%BF%E7%94%A8harbor"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.3.2 配置docker daemon使用harbor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-docker-swarm%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 docker swarm集群初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E8%8E%B7%E5%8F%96docker-swarm%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 获取docker swarm命令帮助</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E5%9C%A8%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 在管理节点初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 添加工作节点到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 添加管理节点到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5-%E6%A8%A1%E6%8B%9F%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%87%BA%E7%8E%B0%E6%95%85%E9%9A%9C"><span class="toc-number">3.4.5.</span> <span class="toc-text">3.4.5 模拟管理节点出现故障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-5-1-%E5%81%9C%E6%AD%A2docker%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.5.1.</span> <span class="toc-text">3.4.5.1 停止docker服务并查看结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-5-2-%E5%90%AF%E5%8A%A8docker%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.5.2.</span> <span class="toc-text">3.4.5.2 启动docker服务并查看结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81docker-swarm%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">四、docker swarm集群应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%87%86%E5%A4%87"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 容器镜像准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-v1%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 v1版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-v2%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 v2版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 发布服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E4%BD%BF%E7%94%A8docker-service-ls%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 使用docker service ls查看服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 发布服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 查看已发布服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 查看已发布服务容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-%E8%AE%BF%E9%97%AE%E5%B7%B2%E5%8F%91%E5%B8%83%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.5.</span> <span class="toc-text">4.2.5 访问已发布的服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%9C%8D%E5%8A%A1%E6%89%A9%E5%B1%95"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 服务扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%9C%8D%E5%8A%A1%E8%A3%81%E5%87%8F"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 服务裁减</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.6.</span> <span class="toc-text">4.6  删除服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 服务版本更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E5%9B%9E%E9%80%80"><span class="toc-number">4.8.</span> <span class="toc-text">4.8 服务版本回退</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E6%BB%9A%E5%8A%A8%E9%97%B4%E9%9A%94%E6%9B%B4%E6%96%B0"><span class="toc-number">4.9.</span> <span class="toc-text">4.9 服务版本滚动间隔更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-%E5%89%AF%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">4.10.</span> <span class="toc-text">4.10 副本控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11-%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.11.</span> <span class="toc-text">4.11 在指定网络中发布服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12-%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.12.</span> <span class="toc-text">4.12 服务网络模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-13-%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.</span> <span class="toc-text">4.13 服务数据持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-1-%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.1.</span> <span class="toc-text">4.13.1 本地存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-1-%E5%9C%A8%E9%9B%86%E7%BE%A4%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E4%B8%8A%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.13.1.1.</span> <span class="toc-text">4.13.1.1 在集群所有主机上创建本地目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%E6%97%B6%E6%8C%82%E8%BD%BD%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95%E5%88%B0%E5%AE%B9%E5%99%A8%E4%B8%AD"><span class="toc-number">4.13.1.2.</span> <span class="toc-text">4.13.1.2 发布服务时挂载本地目录到容器中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-3-%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.13.1.3.</span> <span class="toc-text">4.13.1.3 验证是否使用本地目录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-2-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.2.</span> <span class="toc-text">4.13.2 网络存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-1-%E9%83%A8%E7%BD%B2NFS%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.2.1.</span> <span class="toc-text">4.13.2.1 部署NFS存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-2-%E4%B8%BA%E9%9B%86%E7%BE%A4%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E5%AE%89%E8%A3%85nfs-utils%E8%BD%AF%E4%BB%B6"><span class="toc-number">4.13.2.2.</span> <span class="toc-text">4.13.2.2 为集群所有主机安装nfs-utils软件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-3-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">4.13.2.3.</span> <span class="toc-text">4.13.2.3 创建存储卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-4-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.13.2.4.</span> <span class="toc-text">4.13.2.4 发布服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-5-%E9%AA%8C%E8%AF%81"><span class="toc-number">4.13.2.5.</span> <span class="toc-text">4.13.2.5 验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14-%E6%9C%8D%E5%8A%A1%E4%BA%92%E8%81%94%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">4.14.</span> <span class="toc-text">4.14 服务互联与服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-15-docker-swarm%E7%BD%91%E7%BB%9C"><span class="toc-number">4.15.</span> <span class="toc-text">4.15 docker swarm网络</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81docker-stack"><span class="toc-number">5.</span> <span class="toc-text">五、docker stack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-docker-stack%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 docker stack介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-docker-stack%E4%B8%8Edocker-compose%E5%8C%BA%E5%88%AB"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 docker stack与docker compose区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-docker-stack%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 docker stack常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E9%83%A8%E7%BD%B2wordpress%E6%A1%88%E4%BE%8B"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 部署wordpress案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E9%83%A8%E7%BD%B2nginx%E4%B8%8Eweb%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">5.5.</span> <span class="toc-text">5.5  部署nginx与web管理服务案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-nginx-haproxy-nfs%E6%A1%88%E4%BE%8B"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 nginx+haproxy+nfs案例</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Docker主机集群化方案Docker Swarm
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">祥祥要起飞</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-17T00:48:22.000Z" itemprop="datePublished">2023-08-17</time>
        
      
    </div>


      <div class="posteye">
    <i class="fas fa-eye"></i>
    <span id="/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/" class="leancloud-visitors" data-flag-title="Docker主机集群化方案Docker Swarm" style="display: inline;">
        <span class="leancloud-visitors-count"></span>
    </span>
</div>
      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Docker/" rel="tag">Docker</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="一、docker-swarm介绍"><a href="#一、docker-swarm介绍" class="headerlink" title="一、docker swarm介绍"></a>一、docker swarm介绍</h1><p>Docker Swarm是Docker官方提供的一款集群管理工具，其主要作用是把若干台Docker主机抽象为一个整体，并且通过一个入口统一管理这些Docker主机上的各种Docker资源。Swarm和Kubernetes比较类似，但是更加轻，具有的功能也较kubernetes更少一些。</p>
<ul>
<li>是docker host集群管理工具</li>
<li>docker官方提供的</li>
<li>docker 1.12版本以后</li>
<li>用来统一集群管理的，把整个集群资源做统一调度</li>
<li>比kubernetes要轻量化</li>
<li>实现scaling 规模扩大或缩小</li>
<li>实现rolling update 滚动更新或版本回退</li>
<li>实现service discovery 服务发现</li>
<li>实现load balance 负载均衡</li>
<li>实现route mesh 路由网格，服务治理</li>
</ul>
<h1 id="二、docker-swarm概念与架构"><a href="#二、docker-swarm概念与架构" class="headerlink" title="二、docker swarm概念与架构"></a>二、docker swarm概念与架构</h1><blockquote>
<p>参考网址：<a target="_blank" rel="noopener" href="https://docs.docker.com/swarm/overview/">https://docs.docker.com/swarm/overview/</a></p>
</blockquote>
<h2 id="2-1-架构"><a href="#2-1-架构" class="headerlink" title="2.1 架构"></a>2.1 架构</h2><p>![](/images/Docker/Docker主机集群化方案DockerSwarm.assets/docker swarm架构图.png)</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216093807929.png" alt="image-20220216093807929"></p>
<h2 id="2-2-概念"><a href="#2-2-概念" class="headerlink" title="2.2 概念"></a>2.2 概念</h2><p><strong>节点 (node):</strong> 就是一台docker host上面运行了docker engine.节点分为两类:</p>
<ul>
<li>管理节点(manager node) 负责管理集群中的节点并向工作节点分配任务</li>
<li>工作节点(worker node) 接收管理节点分配的任务，运行任务</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker node ls</span></span><br></pre></td></tr></table></figure>





<p><strong>服务(services):</strong> 在工作节点运行的，由多个任务共同组成</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service ls</span></span><br></pre></td></tr></table></figure>





<p><strong>任务(task):</strong> 运行在工作节点上容器或容器中包含应用，是集群中调度最小管理单元</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216093706989.png" alt="image-20220216093706989"></p>
<h1 id="三、docker-swarm集群部署"><a href="#三、docker-swarm集群部署" class="headerlink" title="三、docker swarm集群部署"></a>三、docker swarm集群部署</h1><blockquote>
<p>部署3主2从节点集群，另需提前准备1台本地容器镜像仓库服务器(Harbor)</p>
</blockquote>
<h2 id="3-1-容器镜像仓库-Harbor准备"><a href="#3-1-容器镜像仓库-Harbor准备" class="headerlink" title="3.1 容器镜像仓库 Harbor准备"></a>3.1 容器镜像仓库 Harbor准备</h2><p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216111914692.png" alt="image-20220216111914692"></p>
<h2 id="3-2-主机准备"><a href="#3-2-主机准备" class="headerlink" title="3.2 主机准备"></a>3.2 主机准备</h2><h3 id="3-2-1-主机名"><a href="#3-2-1-主机名" class="headerlink" title="3.2.1 主机名"></a>3.2.1 主机名</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hostnamectl set-hostname xxx</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">sm1 管理节点<span class="number">1</span></span><br><span class="line">sm2 管理节点<span class="number">2</span></span><br><span class="line">sm3 管理节点<span class="number">3</span></span><br><span class="line">sw1 工作节点<span class="number">1</span></span><br><span class="line">sw2 工作节点<span class="number">2</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-IP地址"><a href="#3-2-2-IP地址" class="headerlink" title="3.2.2 IP地址"></a>3.2.2 IP地址</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">编辑网卡配置文件</span><br><span class="line"><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line"><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-ens33</span></span><br><span class="line"><span class="built_in">TYPE</span>=<span class="string">&quot;Ethernet&quot;</span></span><br><span class="line">PROXY_METHOD=<span class="string">&quot;none&quot;</span></span><br><span class="line">BROWSER_ONLY=<span class="string">&quot;no&quot;</span></span><br><span class="line">BOOTPROTO=<span class="string">&quot;none&quot;</span> 修改为静态</span><br><span class="line">DEFROUTE=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV4_FAILURE_FATAL=<span class="string">&quot;no&quot;</span></span><br><span class="line">IPV6INIT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_AUTOCONF=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_DEFROUTE=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_FAILURE_FATAL=<span class="string">&quot;no&quot;</span></span><br><span class="line">IPV6_ADDR_GEN_MODE=<span class="string">&quot;stable-privacy&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;ens33&quot;</span></span><br><span class="line"></span><br><span class="line">DEVICE=<span class="string">&quot;ens33&quot;</span></span><br><span class="line">ONBOOT=<span class="string">&quot;yes&quot;</span></span><br><span class="line"></span><br><span class="line">添加如下内容：</span><br><span class="line">IPADDR=<span class="string">&quot;192.168.10.xxx&quot;</span></span><br><span class="line">PREFIX=<span class="string">&quot;24&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;192.168.10.2&quot;</span></span><br><span class="line">DNS1=<span class="string">&quot;119.29.29.29&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">sm1 管理节点<span class="number">1</span> <span class="number">192.168</span>.<span class="number">10.10</span></span><br><span class="line">sm2 管理节点<span class="number">2</span> <span class="number">192.168</span>.<span class="number">10.11</span></span><br><span class="line">sm3 管理节点<span class="number">3</span> <span class="number">192.168</span>.<span class="number">10.12</span></span><br><span class="line">sw1 工作节点<span class="number">1</span> <span class="number">192.168</span>.<span class="number">10.13</span></span><br><span class="line">sw2 工作节点<span class="number">2</span> <span class="number">192.168</span>.<span class="number">10.14</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-3-主机名与IP地址解析"><a href="#3-2-3-主机名与IP地址解析" class="headerlink" title="3.2.3 主机名与IP地址解析"></a>3.2.3 主机名与IP地址解析</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">编辑主机/etc/hosts文件，添加主机名解析</span><br><span class="line"><span class="comment"># vim /etc/hosts</span></span><br><span class="line"><span class="comment"># cat /etc/hosts</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.10</span> sm1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.11</span> sm2</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.12</span> sm3</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.13</span> sw1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.14</span> sw2</span><br></pre></td></tr></table></figure>



<h3 id="3-3-4-主机时间同步"><a href="#3-3-4-主机时间同步" class="headerlink" title="3.3.4 主机时间同步"></a>3.3.4 主机时间同步</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">添加计划任务，实现时间同步，同步服务器为time1.aliyun.com</span><br><span class="line"><span class="comment"># crontab -e</span></span><br><span class="line">no crontab <span class="keyword">for</span> root - <span class="keyword">using</span> an empty one</span><br><span class="line">crontab: installing new crontab</span><br><span class="line"></span><br><span class="line">查看添加后计划任务</span><br><span class="line"><span class="comment"># crontab -l</span></span><br><span class="line"><span class="number">0</span> */<span class="number">1</span> * * * ntpdate time1.aliyun.com</span><br></pre></td></tr></table></figure>



<h3 id="3-2-5-主机安全设置"><a href="#3-2-5-主机安全设置" class="headerlink" title="3.2.5 主机安全设置"></a>3.2.5 主机安全设置</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">关闭防火墙并查看其运行状态</span><br><span class="line"><span class="comment"># systemctl stop firewalld;systemctl disable firewalld</span></span><br><span class="line"><span class="comment"># firewall-cmd --state</span></span><br><span class="line">not running</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用非交互式修改selinux配置文件</span><br><span class="line"><span class="comment"># sed -ri &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line">重启所有的主机系统</span><br><span class="line"><span class="comment"># reboot</span></span><br><span class="line"></span><br><span class="line">重启后验证selinux是否关闭</span><br><span class="line"><span class="comment"># sestatus</span></span><br><span class="line">SELinux status:                 disabled</span><br></pre></td></tr></table></figure>





<h2 id="3-3-docker安装"><a href="#3-3-docker安装" class="headerlink" title="3.3 docker安装"></a>3.3 docker安装</h2><h3 id="3-3-1-docker安装"><a href="#3-3-1-docker安装" class="headerlink" title="3.3.1 docker安装"></a>3.3.1 docker安装</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下载YUM源</span><br><span class="line"><span class="comment"># wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装docker<span class="literal">-ce</span></span><br><span class="line"><span class="comment"># yum -y install docker-ce</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">启动docker服务并设置为开机自启动</span><br><span class="line"><span class="comment"># systemctl enable docker;systemctl start docker</span></span><br></pre></td></tr></table></figure>



<h3 id="3-3-2-配置docker-daemon使用harbor"><a href="#3-3-2-配置docker-daemon使用harbor" class="headerlink" title="3.3.2 配置docker daemon使用harbor"></a>3.3.2 配置docker daemon使用harbor</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">添加daemon.json文件，配置docker daemon使用harbor</span><br><span class="line"><span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line"><span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;http://192.168.10.15&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重启docker服务</span><br><span class="line"><span class="comment"># ystemctl restart docker</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">深度登录harbor</span><br><span class="line"><span class="comment"># docker login 192.168.10.15</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: <span class="number">12345</span></span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>



<h2 id="3-4-docker-swarm集群初始化"><a href="#3-4-docker-swarm集群初始化" class="headerlink" title="3.4 docker swarm集群初始化"></a>3.4 docker swarm集群初始化</h2><h3 id="3-4-1-获取docker-swarm命令帮助"><a href="#3-4-1-获取docker-swarm命令帮助" class="headerlink" title="3.4.1 获取docker swarm命令帮助"></a>3.4.1 获取docker swarm命令帮助</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">获取docker swarm命令使用帮助</span><br><span class="line"><span class="comment"># docker swarm --help</span></span><br><span class="line"></span><br><span class="line">Usage:  docker swarm COMMAND</span><br><span class="line"></span><br><span class="line">Manage Swarm</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  ca          Display and rotate the root CA</span><br><span class="line">  init        Initialize a swarm                    初始化</span><br><span class="line">  join        Join a swarm as a node and/or manager 加入集群</span><br><span class="line">  <span class="built_in">join-token</span>  Manage join tokens                    集群加入时token管理</span><br><span class="line">  leave       Leave the swarm                       离开集群</span><br><span class="line">  unlock      Unlock swarm</span><br><span class="line">  <span class="built_in">unlock-key</span>  Manage the unlock key</span><br><span class="line">  update      Update the swarm                      更新集群</span><br></pre></td></tr></table></figure>







<h3 id="3-4-2-在管理节点初始化"><a href="#3-4-2-在管理节点初始化" class="headerlink" title="3.4.2 在管理节点初始化"></a>3.4.2 在管理节点初始化</h3><blockquote>
<p>本次在sm1上初始化</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">初始化集群</span><br><span class="line"><span class="comment"># docker swarm init --advertise-addr 192.168.10.10 --listen-addr 192.168.10.10:2377</span></span><br><span class="line">Swarm initialized: current node (j42cwubrr70pwxdpmesn1cuo6) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join -<span class="literal">-token</span> SWMTKN<span class="literal">-1</span><span class="literal">-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4</span><span class="literal">-6pddlyiq5f1i35w8d7q4bl1co</span> <span class="number">192.168</span>.<span class="number">10.10</span>:<span class="number">2377</span></span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run <span class="string">&#x27;docker swarm join-token manager&#x27;</span> and follow the instructions.</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">-<span class="literal">-advertise</span><span class="literal">-addr</span> 当主机有多块网卡时使用其选择其中一块用于广播,用于其它节点连接管理节点使用</span><br><span class="line">-<span class="literal">-listen</span><span class="literal">-addr</span>    监听地址，用于承载集群流量使用</span><br></pre></td></tr></table></figure>





<h3 id="3-4-3-添加工作节点到集群"><a href="#3-4-3-添加工作节点到集群" class="headerlink" title="3.4.3 添加工作节点到集群"></a>3.4.3 添加工作节点到集群</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用初始化过程中生成的token加入集群</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192.168.10.10:2377</span></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看已加入的集群</span><br><span class="line"><span class="comment"># docker node ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">j42cwubrr70pwxdpmesn1cuo6 *   sm1        Ready     Active         Leader           <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line"><span class="number">4</span>yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br></pre></td></tr></table></figure>







<blockquote>
<p>如果使用的token已过期，可以再次生成新的加入集群的方法，如下命令所示。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">重新生成用于添加工作点的token</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker swarm join-token worker</span></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join -<span class="literal">-token</span> SWMTKN<span class="literal">-1</span><span class="literal">-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4</span><span class="literal">-6pddlyiq5f1i35w8d7q4bl1co</span> <span class="number">192.168</span>.<span class="number">10.10</span>:<span class="number">2377</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">加入至集群</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192.168.10.10:2377</span></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">查看node状态</span><br><span class="line"><span class="comment"># docker node ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">j42cwubrr70pwxdpmesn1cuo6 *   sm1        Ready     Active         Leader           <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line"><span class="number">4</span>yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br></pre></td></tr></table></figure>





<h3 id="3-4-4-添加管理节点到集群"><a href="#3-4-4-添加管理节点到集群" class="headerlink" title="3.4.4 添加管理节点到集群"></a>3.4.4 添加管理节点到集群</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">生成用于添加管理节点加入集群所使用的token</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker swarm join-token manager</span></span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join -<span class="literal">-token</span> SWMTKN<span class="literal">-1</span><span class="literal">-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4</span><span class="literal">-7g85apo82mwz8ttmgdr7onfhu</span> <span class="number">192.168</span>.<span class="number">10.10</span>:<span class="number">2377</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">加入集群</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-7g85apo82mwz8ttmgdr7onfhu 192.168.10.10:2377</span></span><br><span class="line">This node joined a swarm as a manager.</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">加入集群</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-7g85apo82mwz8ttmgdr7onfhu 192.168.10.10:2377</span></span><br><span class="line">This node joined a swarm as a manager.</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看节点状态</span><br><span class="line"><span class="comment"># docker node ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">j42cwubrr70pwxdpmesn1cuo6 *   sm1        Ready     Active         Leader           <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">nzpmehm8n87b9a17or2el10lc     sm2        Ready     Active         Reachable        <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line"><span class="number">4</span>yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br></pre></td></tr></table></figure>



<h3 id="3-4-5-模拟管理节点出现故障"><a href="#3-4-5-模拟管理节点出现故障" class="headerlink" title="3.4.5 模拟管理节点出现故障"></a>3.4.5 模拟管理节点出现故障</h3><h4 id="3-4-5-1-停止docker服务并查看结果"><a href="#3-4-5-1-停止docker服务并查看结果" class="headerlink" title="3.4.5.1 停止docker服务并查看结果"></a>3.4.5.1 停止docker服务并查看结果</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">停止docker服务</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># systemctl stop docker</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看node状态，发现sm1不可达，状态为未知，并重启选择出leader</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker node ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">j42cwubrr70pwxdpmesn1cuo6     sm1        Unknown   Active         Unreachable      <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">nzpmehm8n87b9a17or2el10lc *   sm2        Ready     Active         Leader           <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line"><span class="number">4</span>yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br></pre></td></tr></table></figure>



<h4 id="3-4-5-2-启动docker服务并查看结果"><a href="#3-4-5-2-启动docker服务并查看结果" class="headerlink" title="3.4.5.2 启动docker服务并查看结果"></a>3.4.5.2 启动docker服务并查看结果</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">再次重动docker</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># systemctl start docker</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">观察可以得知sm1是可达状态，但并不是Leader</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker node ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">j42cwubrr70pwxdpmesn1cuo6 *   sm1        Ready     Active         Reachable        <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">nzpmehm8n87b9a17or2el10lc     sm2        Ready     Active         Leader           <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line"><span class="number">4</span>yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br><span class="line">mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          <span class="number">20.10</span>.<span class="number">12</span></span><br></pre></td></tr></table></figure>





<h1 id="四、docker-swarm集群应用"><a href="#四、docker-swarm集群应用" class="headerlink" title="四、docker swarm集群应用"></a>四、docker swarm集群应用</h1><h2 id="4-1-容器镜像准备"><a href="#4-1-容器镜像准备" class="headerlink" title="4.1 容器镜像准备"></a>4.1 容器镜像准备</h2><blockquote>
<p>准备多个版本的容器镜像，以便于后期使用测试。</p>
</blockquote>
<h3 id="4-1-1-v1版本"><a href="#4-1-1-v1版本" class="headerlink" title="4.1.1 v1版本"></a>4.1.1 v1版本</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">生成网站文件v1版</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># vim index.html</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># cat index.html</span></span><br><span class="line">v1</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">编写Dockerfile文件，用于构建容器镜像</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM nginx:latest</span><br><span class="line"></span><br><span class="line">MAINTAINER  <span class="string">&#x27;tom&lt;tom@kubelixiang.com&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">ADD index.html /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&quot;daemon off;&quot;</span> &gt;&gt; /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">80</span></span><br><span class="line"></span><br><span class="line">CMD /usr/sbin/nginx</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用docker build构建容器镜像</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># docker build -t 192.168.10.15/library/nginx:v1 .</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">登录harbor</span><br><span class="line"><span class="comment"># docker login 192.168.10.15</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: <span class="number">12345</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">推送容器镜像至harbor</span><br><span class="line"><span class="comment"># docker push 192.168.10.15/library/nginx:v1</span></span><br></pre></td></tr></table></figure>





<h3 id="4-1-2-v2版本"><a href="#4-1-2-v2版本" class="headerlink" title="4.1.2 v2版本"></a>4.1.2 v2版本</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">生成网站文件v2版</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># vim index.html</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># cat index.html</span></span><br><span class="line">v2</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">编写Dockerfile文件，用于构建容器镜像</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM nginx:latest</span><br><span class="line"></span><br><span class="line">MAINTAINER  <span class="string">&#x27;tom&lt;tom@kubelixiang.com&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">ADD index.html /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&quot;daemon off;&quot;</span> &gt;&gt; /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">80</span></span><br><span class="line"></span><br><span class="line">CMD /usr/sbin/nginx</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用docker build构建容器镜像</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># docker build -t 192.168.10.15/library/nginx:v2 .</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">推送镜像至Harbor</span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> <span class="type">nginximg</span>]<span class="comment"># docker push 192.168.10.15/library/nginx:v2</span></span><br></pre></td></tr></table></figure>



<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216163257339.png" alt="image-20220216163257339"></p>
<h2 id="4-2-发布服务"><a href="#4-2-发布服务" class="headerlink" title="4.2 发布服务"></a>4.2 发布服务</h2><p>在docker swarm中,对外暴露的是服务（service)，而不是容器。</p>
<p>为了保持高可用架构，它准许同时启动多个容器共同支撑一个服务，如果一个容器挂了，它会自动使用另一个容器</p>
<h3 id="4-2-1-使用docker-service-ls查看服务"><a href="#4-2-1-使用docker-service-ls查看服务" class="headerlink" title="4.2.1 使用docker service ls查看服务"></a>4.2.1 使用<code>docker service ls</code>查看服务</h3><blockquote>
<p>在管理节点（manager node）上操作</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID        NAME      MODE      REPLICAS   IMAGE     PORTS</span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-发布服务"><a href="#4-2-2-发布服务" class="headerlink" title="4.2.2 发布服务"></a>4.2.2 发布服务</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create --name nginx-svc-1 --replicas 1 --publish 80:80  192.168.10.15/library/nginx:v1</span></span><br><span class="line">ucif0ibkjqrd7meal6vqwnduz</span><br><span class="line">overall progress: <span class="number">1</span> out of <span class="number">1</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">说明</span><br><span class="line">* 创建一个服务,名为nginx_svc<span class="literal">-1</span></span><br><span class="line">* replicas <span class="number">1</span>指定<span class="number">1</span>个副本</span><br><span class="line">* -<span class="literal">-publish</span> <span class="number">80</span>:<span class="number">80</span>  将服务内部的<span class="number">80</span>端口发布到外部网络的<span class="number">80</span>端口</span><br><span class="line">* 使用的镜像为`192.<span class="number">168.10</span>.<span class="number">15</span>/library/nginx:v1`</span><br></pre></td></tr></table></figure>







<h3 id="4-2-3-查看已发布服务"><a href="#4-2-3-查看已发布服务" class="headerlink" title="4.2.3 查看已发布服务"></a>4.2.3 查看已发布服务</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME          MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">ucif0ibkjqrd   nginx<span class="literal">-svc</span><span class="literal">-1</span>   replicated   <span class="number">1</span>/<span class="number">1</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>



<h3 id="4-2-4-查看已发布服务容器"><a href="#4-2-4-查看已发布服务容器" class="headerlink" title="4.2.4 查看已发布服务容器"></a>4.2.4 查看已发布服务容器</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps  nginx-svc-1</span></span><br><span class="line">ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line"><span class="number">47</span>t0s0egf6xf   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw1       Running         Running <span class="number">48</span> minutes ago</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line"><span class="number">1</span>bdf8981f511   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">53</span> minutes ago   Up <span class="number">53</span> minutes   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1.47</span>t0s0egf6xf1n8m0c0jez3q0</span><br></pre></td></tr></table></figure>



<h3 id="4-2-5-访问已发布的服务"><a href="#4-2-5-访问已发布的服务" class="headerlink" title="4.2.5 访问已发布的服务"></a>4.2.5 访问已发布的服务</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">v1</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.11</span></span><br><span class="line">v1</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.12</span></span><br><span class="line">v1</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.13</span></span><br><span class="line">v1</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.14</span></span><br><span class="line">v1</span><br></pre></td></tr></table></figure>



<p><strong>在集群之外的主机访问</strong></p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216174612048.png" alt="image-20220216174612048"></p>
<h2 id="4-3-服务扩展"><a href="#4-3-服务扩展" class="headerlink" title="4.3 服务扩展"></a>4.3 服务扩展</h2><p>使用scale指定副本数来扩展</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service scale nginx-svc-1=2</span></span><br><span class="line">nginx<span class="literal">-svc</span><span class="literal">-1</span> scaled to <span class="number">2</span></span><br><span class="line">overall progress: <span class="number">2</span> out of <span class="number">2</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">2</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">2</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME          MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">ucif0ibkjqrd   nginx<span class="literal">-svc</span><span class="literal">-1</span>   replicated   <span class="number">2</span>/<span class="number">2</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc-1</span></span><br><span class="line">ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE               ERROR     PORTS</span><br><span class="line"><span class="number">47</span>t0s0egf6xf   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw1       Running         Running about an hour ago</span><br><span class="line">oy16nuh5udn0   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">2</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw2       Running         Running <span class="number">57</span> seconds ago</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED             STATUS             PORTS     NAMES</span><br><span class="line"><span class="number">1</span>bdf8981f511   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About an hour ago   Up About an hour   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1.47</span>t0s0egf6xf1n8m0c0jez3q0</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED              STATUS              PORTS     NAMES</span><br><span class="line"><span class="number">0923</span>c0d10223   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About a minute ago   Up About a minute   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">2</span>.oy16nuh5udn0s1hda5bcpr9hd</span><br></pre></td></tr></table></figure>



<p><strong>问题：现在仅扩展为2个副本，如果把服务扩展到3个副本，集群会如何分配主机呢？</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service scale nginx-svc-1=3</span></span><br><span class="line">nginx<span class="literal">-svc</span><span class="literal">-1</span> scaled to <span class="number">3</span></span><br><span class="line">overall progress: <span class="number">3</span> out of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc-1</span></span><br><span class="line">ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE               ERROR     PORTS</span><br><span class="line"><span class="number">47</span>t0s0egf6xf   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw1       Running         Running about an hour ago</span><br><span class="line">oy16nuh5udn0   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">2</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw2       Running         Running <span class="number">12</span> minutes ago</span><br><span class="line">mn9fwxqbc9d1   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">3</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm1       Running         Running <span class="number">9</span> minutes ago</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">当把服务扩展到一定数量时，管理节点也会参与到负载运行中来。</span><br></pre></td></tr></table></figure>





<h2 id="4-4-服务裁减"><a href="#4-4-服务裁减" class="headerlink" title="4.4 服务裁减"></a>4.4 服务裁减</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service scale nginx-svc-1=2</span></span><br><span class="line">nginx<span class="literal">-svc</span><span class="literal">-1</span> scaled to <span class="number">2</span></span><br><span class="line">overall progress: <span class="number">2</span> out of <span class="number">2</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">2</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">2</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME          MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">ucif0ibkjqrd   nginx<span class="literal">-svc</span><span class="literal">-1</span>   replicated   <span class="number">2</span>/<span class="number">2</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc-1</span></span><br><span class="line">ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line"><span class="number">47</span>t0s0egf6xf   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw1       Running         Running <span class="number">2</span> hours ago</span><br><span class="line">oy16nuh5udn0   nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">2</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw2       Running         Running <span class="number">29</span> minutes ago</span><br></pre></td></tr></table></figure>



<h2 id="4-5-负载均衡"><a href="#4-5-负载均衡" class="headerlink" title="4.5 负载均衡"></a>4.5 负载均衡</h2><blockquote>
<p>服务中包含多个容器时，每次访问将以轮询的方式访问到每个容器</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修改sw1主机中容器网页文件</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED             STATUS             PORTS     NAMES</span><br><span class="line"><span class="number">1</span>bdf8981f511   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About an hour ago   Up About an hour   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">1.47</span>t0s0egf6xf1n8m0c0jez3q0</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker exec -it 1bdf bash</span></span><br><span class="line">root@<span class="number">1</span>bdf8981f511:/<span class="comment"># echo &quot;sw1 web&quot; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@<span class="number">1</span>bdf8981f511:/<span class="comment"># exit</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修改sw2主机中容器网页文件</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line"><span class="number">0923</span>c0d10223   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">42</span> minutes ago   Up <span class="number">42</span> minutes   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span><span class="literal">-1</span>.<span class="number">2</span>.oy16nuh5udn0s1hda5bcpr9hd</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># docker exec -it 0923 bash</span></span><br><span class="line">root@<span class="number">0923</span>c0d10223:/<span class="comment"># echo &quot;sw2 web&quot; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@<span class="number">0923</span>c0d10223:/<span class="comment"># exit</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sw1 web</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sw2 web</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sw1 web</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sw2 web</span><br></pre></td></tr></table></figure>



<h2 id="4-6-删除服务"><a href="#4-6-删除服务" class="headerlink" title="4.6  删除服务"></a>4.6  删除服务</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME          MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">ucif0ibkjqrd   nginx<span class="literal">-svc</span><span class="literal">-1</span>   replicated   <span class="number">2</span>/<span class="number">2</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service rm nginx-svc-1</span></span><br><span class="line">nginx<span class="literal">-svc</span><span class="literal">-1</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID        NAME      MODE      REPLICAS   IMAGE     PORTS</span><br></pre></td></tr></table></figure>



<h2 id="4-7-服务版本更新"><a href="#4-7-服务版本更新" class="headerlink" title="4.7 服务版本更新"></a>4.7 服务版本更新</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create --name nginx-svc --replicas=1 --publish 80:80 192.168.10.15/library/nginx:v1</span></span><br><span class="line">yz3wq6f1cgf10vtq5ne4qfwjz</span><br><span class="line">overall progress: <span class="number">1</span> out of <span class="number">1</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">v1</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service update nginx-svc --image 192.168.10.15/library/nginx:v2</span></span><br><span class="line">nginx<span class="literal">-svc</span></span><br><span class="line">overall progress: <span class="number">1</span> out of <span class="number">1</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">v2</span><br></pre></td></tr></table></figure>





<h2 id="4-8-服务版本回退"><a href="#4-8-服务版本回退" class="headerlink" title="4.8 服务版本回退"></a>4.8 服务版本回退</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service update nginx-svc --image 192.168.10.15/library/nginx:v1</span></span><br><span class="line">nginx<span class="literal">-svc</span></span><br><span class="line">overall progress: <span class="number">1</span> out of <span class="number">1</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<h2 id="4-9-服务版本滚动间隔更新"><a href="#4-9-服务版本滚动间隔更新" class="headerlink" title="4.9 服务版本滚动间隔更新"></a>4.9 服务版本滚动间隔更新</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service create --name nginx-svc --replicas 60 --publish 80:80 192.168.10.15/library/nginx:v1</span></span><br><span class="line">pqrt561dckg2wfpect3vf9ll0</span><br><span class="line">overall progress: <span class="number">60</span> out of <span class="number">60</span> tasks</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service update --replicas 60 --image 192.168.10.15/library/nginx:v2 --update-parallelism 5 --update-delay 30s nginx-svc</span></span><br><span class="line">nginx<span class="literal">-svc</span></span><br><span class="line">overall progress: <span class="number">3</span> out of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">说明</span><br><span class="line">* -<span class="literal">-update</span><span class="literal">-parallelism</span> <span class="number">5</span> 指定并行更新数量</span><br><span class="line">* -<span class="literal">-update</span><span class="literal">-delay</span> <span class="number">30</span>s 指定更新间隔时间</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker swarm滚动更新会造成节点上有<span class="keyword">exit</span>状态的容器,可以考虑清除</span><br><span class="line">命令如下：</span><br><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker container prune</span></span><br><span class="line">WARNING! This will remove all stopped containers.</span><br><span class="line">Are you sure you want to <span class="keyword">continue</span>? [<span class="type">y</span>/<span class="type">N</span>] y</span><br></pre></td></tr></table></figure>



<h2 id="4-10-副本控制器"><a href="#4-10-副本控制器" class="headerlink" title="4.10 副本控制器"></a>4.10 副本控制器</h2><blockquote>
<p>副本控制器</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME        MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">yz3wq6f1cgf1   nginx<span class="literal">-svc</span>   replicated   <span class="number">3</span>/<span class="number">3</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc</span></span><br><span class="line">ID             NAME              IMAGE                            NODE      DESIRED STATE   CURRENT STATE          ERROR     PORTS</span><br><span class="line">x78l0santsbb   nginx<span class="literal">-svc</span>.<span class="number">1</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw2       Running         Running <span class="number">3</span> hours ago</span><br><span class="line">ura9isskfxku    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm1       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line">z738gvgazish    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw1       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line"><span class="number">3</span>qsrkkxn32bl    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm3       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line">psbi0mxu3amy   nginx<span class="literal">-svc</span>.<span class="number">2</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw1       Running         Running <span class="number">3</span> hours ago</span><br><span class="line">zpjw39bwhd78   nginx<span class="literal">-svc</span>.<span class="number">3</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sm1       Running         Running <span class="number">3</span> hours ago</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                            COMMAND                  CREATED       STATUS       PORTS     NAMES</span><br><span class="line"><span class="number">81</span>fffd9132d8   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">3</span> hours ago   Up <span class="number">3</span> hours   <span class="number">80</span>/tcp    nginx<span class="literal">-svc</span>.<span class="number">3</span>.zpjw39bwhd78pw49svpy4q8zd</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker stop 81fffd9132d8;docker rm 81fffd9132d8</span></span><br><span class="line"><span class="number">81</span>fffd9132d8</span><br><span class="line"><span class="number">81</span>fffd9132d8</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME        MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">yz3wq6f1cgf1   nginx<span class="literal">-svc</span>   replicated   <span class="number">3</span>/<span class="number">3</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc</span></span><br><span class="line">ID             NAME              IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR                         PORTS</span><br><span class="line">x78l0santsbb   nginx<span class="literal">-svc</span>.<span class="number">1</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw2       Running         Running <span class="number">3</span> hours ago</span><br><span class="line">ura9isskfxku    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm1       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line">z738gvgazish    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw1       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line"><span class="number">3</span>qsrkkxn32bl    \_ nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm3       Shutdown        Shutdown <span class="number">3</span> hours ago</span><br><span class="line">psbi0mxu3amy   nginx<span class="literal">-svc</span>.<span class="number">2</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sw1       Running         Running <span class="number">3</span> hours ago</span><br><span class="line">qv6ya3crz1fj   nginx<span class="literal">-svc</span>.<span class="number">3</span>       <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sm1       Running         Running <span class="number">13</span> seconds ago</span><br><span class="line">zpjw39bwhd78    \_ nginx<span class="literal">-svc</span>.<span class="number">3</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v2   sm1       Shutdown        Failed <span class="number">19</span> seconds ago    <span class="string">&quot;task: non-zero exit (137)&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-11-在指定网络中发布服务"><a href="#4-11-在指定网络中发布服务" class="headerlink" title="4.11 在指定网络中发布服务"></a>4.11 在指定网络中发布服务</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network create -d overlay tomcat-net</span></span><br><span class="line">mrkgccdfddy8zg92ja6fpox7p</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class="line"><span class="number">5</span>ba369c13795   bridge            bridge    local</span><br><span class="line"><span class="number">54568</span>abb541a   docker_gwbridge   bridge    local</span><br><span class="line"><span class="number">4</span>edcb5c4a324   host              host      local</span><br><span class="line">l6xmfxiiseqk   ingress           overlay   swarm</span><br><span class="line"><span class="number">5</span>d06d748c9c7   none              null      local</span><br><span class="line">mrkgccdfddy8   tomcat<span class="literal">-net</span>        overlay   swarm</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network inspect tomcat-net</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;tomcat-net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;mrkgccdfddy8zg92ja6fpox7p&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2022-02-16T13:56:52.338589006Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;swarm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;overlay&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: <span class="type">null</span>,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;10.0.1.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;10.0.1.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: <span class="type">null</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.overlay.vxlanid_list&quot;</span>: <span class="string">&quot;4097&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: <span class="type">null</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">创建名为tomcat<span class="literal">-net</span>的覆盖网络(Overlay Netowork)，这是个二层网络，处于该网络下的docker容器，即使宿主机不一样，也能相互访问</span><br></pre></td></tr></table></figure>









<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service create --name tomcat \</span></span><br><span class="line">-<span class="literal">-network</span> tomcat<span class="literal">-net</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span> \</span><br><span class="line">-<span class="literal">-replicas</span> <span class="number">2</span> \</span><br><span class="line">tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line">创建名为tomcat的服务，使用了刚才创建的覆盖网络</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME      MODE         REPLICAS   IMAGE                        PORTS</span><br><span class="line">wgqkz8vymxkr   tomcat    replicated   <span class="number">2</span>/<span class="number">2</span>        tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   *:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps tomcat</span></span><br><span class="line">ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">fsx1fnssbmtg   tomcat.<span class="number">1</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sm3       Running         Running <span class="number">49</span> seconds ago</span><br><span class="line">gq0ogycj7orb   tomcat.<span class="number">2</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sm2       Running         Running <span class="number">58</span> seconds ago</span><br></pre></td></tr></table></figure>







<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220216222436884.png" alt="image-20220216222436884"></p>
<h2 id="4-12-服务网络模式"><a href="#4-12-服务网络模式" class="headerlink" title="4.12 服务网络模式"></a>4.12 服务网络模式</h2><ul>
<li><p>服务模式一共有两种：Ingress和Host，如果不指定，则默认的是Ingress；</p>
<ul>
<li>Ingress模式下，到达Swarm任何节点的8080端口的流量，都会映射到任何服务副本的内部80端口，就算该节点上没有tomcat服务副本也会映射；</li>
</ul>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service create --name tomcat \</span></span><br><span class="line">-<span class="literal">-network</span> tomcat<span class="literal">-net</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span> \</span><br><span class="line">-<span class="literal">-replicas</span> <span class="number">2</span> \</span><br><span class="line">tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps tomcat</span></span><br><span class="line">ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS</span><br><span class="line">fsx1fnssbmtg   tomcat.<span class="number">1</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sm3       Running         Running <span class="number">8</span> minutes ago</span><br><span class="line">gq0ogycj7orb   tomcat.<span class="number">2</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sm2       Running         Running <span class="number">8</span> minutes ago</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                        COMMAND             CREATED         STATUS         PORTS      NAMES</span><br><span class="line">f650498c8e71   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   <span class="string">&quot;catalina.sh run&quot;</span>   <span class="number">9</span> minutes ago   Up <span class="number">9</span> minutes   <span class="number">8080</span>/tcp   tomcat.<span class="number">2</span>.gq0ogycj7orbu4ua1dwk140as</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker inspect f650498c8e71 | grep IPAddress</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.0.24&quot;</span>, ingress IP地址</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.1.9&quot;</span>,  容器IP地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                        COMMAND             CREATED         STATUS         PORTS      NAMES</span><br><span class="line"><span class="number">9</span>d0c412717d7   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   <span class="string">&quot;catalina.sh run&quot;</span>   <span class="number">9</span> minutes ago   Up <span class="number">9</span> minutes   <span class="number">8080</span>/tcp   tomcat.<span class="number">1</span>.fsx1fnssbmtgv3qh84fgqknlh</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># docker inspect 9d0c412717d7 | grep IPAddress</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.0.23&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.1.8&quot;</span>,</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;dockerd&quot;</span>,pid=<span class="number">2727</span>,fd=<span class="number">54</span>))</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;dockerd&quot;</span>,pid=<span class="number">1229</span>,fd=<span class="number">26</span>))</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;dockerd&quot;</span>,pid=<span class="number">1226</span>,fd=<span class="number">22</span>))</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;dockerd&quot;</span>,pid=<span class="number">1229</span>,fd=<span class="number">39</span>))</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;dockerd&quot;</span>,pid=<span class="number">1229</span>,fd=<span class="number">22</span>))</span><br></pre></td></tr></table></figure>





<ul>
<li>Host模式下，仅在运行有容器副本的机器上开放端口，使用Host模式的命令如下：</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service create --name tomcat \</span></span><br><span class="line">-<span class="literal">-network</span> tomcat<span class="literal">-net</span> \</span><br><span class="line">-<span class="literal">-publish</span> published=<span class="number">8080</span>,target=<span class="number">8080</span>,mode=host \</span><br><span class="line">-<span class="literal">-replicas</span> <span class="number">3</span> \</span><br><span class="line">tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps tomcat</span></span><br><span class="line">ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">x6022h0oungs   tomcat.<span class="number">1</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sw1       Running         Running <span class="number">19</span> seconds ago             *:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp,*:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp</span><br><span class="line">jmnthwqi6ubf   tomcat.<span class="number">2</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sm1       Running         Running <span class="number">18</span> seconds ago             *:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp,*:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp</span><br><span class="line">nvcbijnfy2es   tomcat.<span class="number">3</span>   tomcat:<span class="number">7.0</span>.<span class="number">96</span><span class="literal">-jdk8</span><span class="literal">-openjdk</span>   sw2       Running         Running <span class="number">19</span> seconds ago             *:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp,*:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>       *:<span class="number">8080</span>                  *:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">20963</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">20967</span>,fd=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>       *:<span class="number">8080</span>                  *:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">20459</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">20463</span>,fd=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>       *:<span class="number">8080</span>                  *:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">19938</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">8080</span>               [::]:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">19942</span>,fd=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">没有被映射端口</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># ss -anput | grep &quot;:8080&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-13-服务数据持久化存储"><a href="#4-13-服务数据持久化存储" class="headerlink" title="4.13 服务数据持久化存储"></a>4.13 服务数据持久化存储</h2><h3 id="4-13-1-本地存储"><a href="#4-13-1-本地存储" class="headerlink" title="4.13.1 本地存储"></a>4.13.1 本地存储</h3><h4 id="4-13-1-1-在集群所有主机上创建本地目录"><a href="#4-13-1-1-在集群所有主机上创建本地目录" class="headerlink" title="4.13.1.1 在集群所有主机上创建本地目录"></a>4.13.1.1 在集群所有主机上创建本地目录</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /data/nginxdata</span></span><br></pre></td></tr></table></figure>



<h4 id="4-13-1-2-发布服务时挂载本地目录到容器中"><a href="#4-13-1-2-发布服务时挂载本地目录到容器中" class="headerlink" title="4.13.1.2 发布服务时挂载本地目录到容器中"></a>4.13.1.2 发布服务时挂载本地目录到容器中</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create --name nginx-svc --replicas 3 --mount &quot;type=bind,source=/data/nginxdata,target=/usr/share/nginx/html&quot; --publish 80:80  192.168.10.15/library/nginx:v1</span></span><br><span class="line"></span><br><span class="line">s31z75rniv4p53ycbqch3xbqm</span><br><span class="line">overall progress: <span class="number">3</span> out of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<h4 id="4-13-1-3-验证是否使用本地目录"><a href="#4-13-1-3-验证是否使用本地目录" class="headerlink" title="4.13.1.3 验证是否使用本地目录"></a>4.13.1.3 验证是否使用本地目录</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME        MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">s31z75rniv4p   nginx<span class="literal">-svc</span>   replicated   <span class="number">3</span>/<span class="number">3</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc</span></span><br><span class="line">ID             NAME          IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">vgfhk4lksbtp   nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm2       Running         Running <span class="number">54</span> seconds ago</span><br><span class="line">v2bs9araxeuc   nginx<span class="literal">-svc</span>.<span class="number">2</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw2       Running         Running <span class="number">59</span> seconds ago</span><br><span class="line"><span class="number">1</span>m7fobr3cscz   nginx<span class="literal">-svc</span>.<span class="number">3</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm3       Running         Running <span class="number">59</span> seconds ago</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># ls /data/nginxdata/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># echo &quot;sm2 web&quot; &gt; /data/nginxdata/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># ls /data/nginxdata/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm3</span> ~]<span class="comment"># echo &quot;sm3 web&quot; &gt; /data/nginxdata/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># ls /data/nginxdata</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># echo &quot;sw2 web&quot; &gt; /data/nginxdata/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sm2 web</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sm3 web</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">sw2 web</span><br></pre></td></tr></table></figure>



<blockquote>
<p>存在数据一致性问题</p>
</blockquote>
<h3 id="4-13-2-网络存储"><a href="#4-13-2-网络存储" class="headerlink" title="4.13.2 网络存储"></a>4.13.2 网络存储</h3><ul>
<li>网络存储卷可以实现跨docker宿主机的数据共享,数据持久保存到网络存储卷中</li>
<li>在创建service时添加卷的挂载参数,网络存储卷可以帮助自动挂载(<strong>但需要集群节点都创建该网络存储卷</strong>)</li>
</ul>
<h4 id="4-13-2-1-部署NFS存储"><a href="#4-13-2-1-部署NFS存储" class="headerlink" title="4.13.2.1 部署NFS存储"></a>4.13.2.1 部署NFS存储</h4><blockquote>
<p>本案例以NFS提供远程存储为例</p>
</blockquote>
<blockquote>
<p>在192.168.10.15服务器上部署NFS服务，共享目录为docker swarm集群主机使用。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># mkdir /opt/dockervolume</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># yum -y install nfs-utils</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># cat /etc/exports</span></span><br><span class="line">/opt/dockervolume       *(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># systemctl enable nfs-server</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># systemctl start nfs-server</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># showmount -e</span></span><br><span class="line">Export list <span class="keyword">for</span> harbor:</span><br><span class="line">/opt/dockervolume *</span><br></pre></td></tr></table></figure>



<h4 id="4-13-2-2-为集群所有主机安装nfs-utils软件"><a href="#4-13-2-2-为集群所有主机安装nfs-utils软件" class="headerlink" title="4.13.2.2 为集群所有主机安装nfs-utils软件"></a>4.13.2.2 为集群所有主机安装nfs-utils软件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install nfs-utils</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># showmount -e 192.168.10.15</span></span><br><span class="line">Export list <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">10.15</span>:</span><br><span class="line">/opt/dockervolume *</span><br></pre></td></tr></table></figure>



<h4 id="4-13-2-3-创建存储卷"><a href="#4-13-2-3-创建存储卷" class="headerlink" title="4.13.2.3 创建存储卷"></a>4.13.2.3 创建存储卷</h4><blockquote>
<p>集群中所有节点</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker volume create  --driver local --opt type=nfs --opt o=addr=192.168.10.15,rw --opt device=:/opt/dockervolume nginx_volume</span></span><br><span class="line">nginx_volume</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     nginx_volume</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker volume inspect nginx_volume</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2022-02-16T23:29:11+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/nginx_volume/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;nginx_volume&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;device&quot;</span>: <span class="string">&quot;:/opt/dockervolume&quot;</span>,</span><br><span class="line">            <span class="string">&quot;o&quot;</span>: <span class="string">&quot;addr=192.168.10.15,rw&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;nfs&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h4 id="4-13-2-4-发布服务"><a href="#4-13-2-4-发布服务" class="headerlink" title="4.13.2.4 发布服务"></a>4.13.2.4 发布服务</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create  --name nginx-svc --replicas 3 --publish 80:80 --mount &quot;type=volume,source=nginx_volume,target=/usr/share/nginx/html&quot;  192.168.10.15/library/nginx:v1</span></span><br><span class="line">uh6k84b87n8vciuirln4zqb4v</span><br><span class="line">overall progress: <span class="number">3</span> out of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>



<h4 id="4-13-2-5-验证"><a href="#4-13-2-5-验证" class="headerlink" title="4.13.2.5 验证"></a>4.13.2.5 验证</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME        MODE         REPLICAS   IMAGE                            PORTS</span><br><span class="line">uh6k84b87n8v   nginx<span class="literal">-svc</span>   replicated   <span class="number">3</span>/<span class="number">3</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps nginx-svc</span></span><br><span class="line">ID             NAME          IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">k2vxpav5oadf   nginx<span class="literal">-svc</span>.<span class="number">1</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw2       Running         Running <span class="number">43</span> seconds ago</span><br><span class="line">v8fh0r89wt5i   nginx<span class="literal">-svc</span>.<span class="number">2</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sw1       Running         Running <span class="number">43</span> seconds ago</span><br><span class="line">xb0nyft8ou4d   nginx<span class="literal">-svc</span>.<span class="number">3</span>   <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1   sm1       Running         Running <span class="number">43</span> seconds ago</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># df -Th | grep nfs</span></span><br><span class="line">:/opt/dockervolume      nfs        <span class="number">50</span>G  <span class="number">8.9</span>G   <span class="number">42</span>G   <span class="number">18</span>% /var/lib/docker/volumes/nginx_volume/_data</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># df -Th | grep nfs</span></span><br><span class="line">:/opt/dockervolume      nfs        <span class="number">50</span>G  <span class="number">8.9</span>G   <span class="number">42</span>G   <span class="number">18</span>% /var/lib/docker/volumes/nginx_volume/_data</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># df -Th | grep nfs</span></span><br><span class="line">:/opt/dockervolume      nfs        <span class="number">50</span>G  <span class="number">8.9</span>G   <span class="number">42</span>G   <span class="number">18</span>% /var/lib/docker/volumes/nginx_volume/_data</span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">harbor</span> ~]<span class="comment"># echo &quot;nfs test&quot; &gt; /opt/dockervolume/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.10</span></span><br><span class="line">nfs test</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.11</span></span><br><span class="line">nfs test</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.12</span></span><br><span class="line">nfs test</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.13</span></span><br><span class="line">nfs test</span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># curl http://192.168.10.14</span></span><br><span class="line">nfs test</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="4-14-服务互联与服务发现"><a href="#4-14-服务互联与服务发现" class="headerlink" title="4.14 服务互联与服务发现"></a>4.14 服务互联与服务发现</h2><p>如果一个nginx服务与一个mysql服务之间需要连接,在docker swarm如何实现呢?</p>
<p><strong>方法1:</strong></p>
<p>把mysql服务也使用 <code>--publish</code>参数发布到外网,但这样做的缺点是:mysql这种服务发布到外网不安全</p>
<p><strong>方法2:</strong></p>
<p>将mysql服务等运行在内部网络,只需要nginx服务能够连接mysql就可以了,在docker swarm中可以使用==<strong>overlay</strong>==网络来实现。</p>
<p>但现在还有个问题,服务副本数发生变化时,容器内部的IP发生变化时,我们希望仍然能够访问到这个服务, 这就是**==服务发现（service discovery)==**.</p>
<p><strong>通过服务发现, service的使用者都不需要知道service运行在哪里,IP是多少,有多少个副本,就能让service通信</strong></p>
<p>下面使用<code>docker network ls</code>查看到的ingress网络就是一个overlay类型的网络,但它不支持服务发现</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class="line"><span class="number">5</span>ba369c13795   bridge            bridge    local</span><br><span class="line"><span class="number">54568</span>abb541a   docker_gwbridge   bridge    local</span><br><span class="line"><span class="number">4</span>edcb5c4a324   host              host      local</span><br><span class="line">l6xmfxiiseqk   ingress           overlay   swarm 此处</span><br><span class="line"><span class="number">5</span>d06d748c9c7   none              null      local</span><br><span class="line">mrkgccdfddy8   tomcat<span class="literal">-net</span>        overlay   swarm</span><br></pre></td></tr></table></figure>

<p>我们<strong>需要自建一个overlay网络来实现服务发现, 需要相互通信的service也必须属于同一个overlay网络</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network create --driver overlay --subnet 192.168.100.0/24 self-network</span></span><br><span class="line">ejpf8zzig5rjsgefqucopcsdt</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li>–driver overlay指定为overlay类型</li>
<li>–subnet 分配网段</li>
<li>self-network  为自定义的网络名称</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class="line"><span class="number">5</span>ba369c13795   bridge            bridge    local</span><br><span class="line"><span class="number">54568</span>abb541a   docker_gwbridge   bridge    local</span><br><span class="line"><span class="number">4</span>edcb5c4a324   host              host      local</span><br><span class="line">l6xmfxiiseqk   ingress           overlay   swarm</span><br><span class="line"><span class="number">5</span>d06d748c9c7   none              null      local</span><br><span class="line">ejpf8zzig5rj   self<span class="literal">-network</span>      overlay   swarm 此处</span><br><span class="line">mrkgccdfddy8   tomcat<span class="literal">-net</span>        overlay   swarm</span><br></pre></td></tr></table></figure>



<p><strong>验证自动发现</strong></p>
<p>1, 发布nignx-svc服务,指定在自建的overlay网络</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create --name nginx-svc --replicas 3 --network self-network --publish 80:80  192.168.10.15/library/nginx:v1</span></span><br><span class="line">rr21tvm1xpi6vk3ic83tfy9e5</span><br><span class="line">overall progress: <span class="number">3</span> out of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>

<p>2, 发布一个busybox服务,也指定在自建的overlay网络</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service create --name test --network self-network  busybox sleep 100000</span></span><br><span class="line">w14lzhhzdyqwt18lrby4euw98</span><br><span class="line">overall progress: <span class="number">1</span> out of <span class="number">1</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span>: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li><p>服务名为test</p>
</li>
<li><p>busybox是一个集成了linux常用命令的软件,这里使用它可以比较方便的测试与nginx_service的连通性</p>
</li>
<li><p>没有指定副本,默认1个副本</p>
</li>
<li><p>因为它并不是长时间运行的daemon守护进程,所以运行一下就会退出.sleep 100000是指定一个长的运行时间,让它有足够的时间给我们测试</p>
</li>
</ul>
<p>3, 查出test服务在哪个节点运行的容器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ps test</span></span><br><span class="line">ID             NAME      IMAGE            NODE      DESIRED STATE   CURRENT STATE                ERROR     PORTS</span><br><span class="line">x8nkifpdtyw5   test.<span class="number">1</span>    busybox:latest   sm2       Running         Running about a minute ago</span><br></pre></td></tr></table></figure>

<p>4, 去运行test服务的容器节点查找容器的名称</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE            COMMAND          CREATED              STATUS              PORTS     NAMES</span><br><span class="line"><span class="number">8</span>df13819bd5c   busybox:latest   <span class="string">&quot;sleep 100000&quot;</span>   About a minute ago   Up About a minute             test.<span class="number">1</span>.x8nkifpdtyw5177zhr0r1lxad</span><br></pre></td></tr></table></figure>

<p>5, 使用查找出来的容器名称,执行命令测试</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm2</span> ~]<span class="comment"># docker exec -it test.1.x8nkifpdtyw5177zhr0r1lxad ping -c 2 nginx-svc</span></span><br><span class="line">PING nginx<span class="literal">-svc</span> (<span class="number">192.168</span>.<span class="number">100.2</span>): <span class="number">56</span> <span class="keyword">data</span> bytes</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">100.2</span>: seq=<span class="number">0</span> ttl=<span class="number">64</span> time=<span class="number">0.093</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">100.2</span>: seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.162</span> ms</span><br><span class="line"></span><br><span class="line">--- nginx<span class="literal">-svc</span> ping statistics ---</span><br><span class="line"><span class="number">2</span> packets transmitted, <span class="number">2</span> packets received, <span class="number">0</span>% packet loss</span><br><span class="line">round<span class="literal">-trip</span> min/avg/max = <span class="number">0.093</span>/<span class="number">0.127</span>/<span class="number">0.162</span> ms</span><br></pre></td></tr></table></figure>

<p><strong>测试的结果为: test服务可以ping通nginx_service服务,并且返回的IP为自建网络的一个IP(192.168.100.2)</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service inspect nginx-svc</span></span><br><span class="line">[</span><br><span class="line">  <span class="type">......</span></span><br><span class="line">            <span class="string">&quot;VirtualIPs&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;l6xmfxiiseqkl57wnsm4cykps&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Addr&quot;</span>: <span class="string">&quot;10.0.0.36/24&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;ejpf8zzig5rjsgefqucopcsdt&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Addr&quot;</span>: <span class="string">&quot;192.168.100.2/24&quot;</span> 与此处<span class="type">IP</span>地址保持一致。</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>





<p>6, 分别去各个节点查找nginx_service服务的各个容器(3个副本),发现它们的IP与上面ping的IP都不同</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker inspect nginx-svc.1.6nxixaw3tn2ld3vklfjldnpl5 | grep IPAddress</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.0.37&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;192.168.100.3&quot;</span>,</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw1</span> ~]<span class="comment"># docker inspect nginx-svc.3.steywkaxfboynglx4bsji6jd1 | grep -i ipaddress</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.0.39&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;192.168.100.5&quot;</span>,</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sw2</span> ~]<span class="comment"># docker inspect nginx-svc.2.rz1iifb9eg0tos7r59cbesucd | grep -i ipaddress</span></span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;10.0.0.38&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;192.168.100.4&quot;</span>,</span><br></pre></td></tr></table></figure>



<p>7, 后续测试, 将nginx_service服务扩展,裁减,更新,回退.都不影响test服务访问nginx-svc。</p>
<p><strong>结论: 在自建的overlay网络内,通过服务发现可以实现服务之间通过服务名(不用知道对方的IP)互联,而且不会受服务内副本个数和容器内IP变化等的影响。</strong></p>
<h2 id="4-15-docker-swarm网络"><a href="#4-15-docker-swarm网络" class="headerlink" title="4.15 docker swarm网络"></a>4.15 docker swarm网络</h2><p>在 Swarm Service 中有三个重要的网络概念：</p>
<ul>
<li> <strong>Overlay networks</strong> 管理 Swarm 中 Docker 守护进程间的通信。你可以将服务附加到一个或多个已存在的 <code>overlay</code> 网络上，使得服务与服务之间能够通信。</li>
<li><strong>ingress network</strong> 是一个特殊的 <code>overlay</code> 网络，用于服务节点间的负载均衡。当任何 Swarm 节点在发布的端口上接收到请求时，它将该请求交给一个名为 <code>IPVS</code> 的模块。<code>IPVS</code> 跟踪参与该服务的所有IP地址，选择其中的一个，并通过 <code>ingress</code> 网络将请求路由到它。<br> 初始化或加入 Swarm 集群时会自动创建 <code>ingress</code> 网络，大多数情况下，用户不需要自定义配置，但是 docker 17.05 和更高版本允许你自定义。</li>
<li><strong>docker_gwbridge</strong>是一种桥接网络，将 <code>overlay</code> 网络（包括 <code>ingress</code> 网络）连接到一个单独的 Docker 守护进程的物理网络。默认情况下，服务正在运行的每个容器都连接到本地 Docker 守护进程主机的 <code>docker_gwbridge</code> 网络。<br> <code>docker_gwbridge</code> 网络在初始化或加入 Swarm 时自动创建。大多数情况下，用户不需要自定义配置，但是 Docker 允许自定义。</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>docker_gwbridge</td>
<td>bridge</td>
<td>none</td>
</tr>
<tr>
<td>ingress</td>
<td>overlay</td>
<td>none</td>
</tr>
<tr>
<td>custom-network</td>
<td>overlay</td>
<td>none</td>
</tr>
</tbody></table>
<ul>
<li><p>docker_gwbridge和ingress是swarm自动创建的，当用户执行了docker swarm init/connect之后。</p>
</li>
<li><p>docker_gwbridge是bridge类型的负责本机container和主机直接的连接</p>
</li>
<li><p>ingress负责service在多个主机container之间的路由。</p>
</li>
<li><p>custom-network是用户自己创建的overlay网络，通常我们都需要创建自己的network并把service挂在上面。</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/ingress-routing-mesh.png" alt="service ingress image"></p>
</li>
</ul>
<h1 id="五、docker-stack"><a href="#五、docker-stack" class="headerlink" title="五、docker stack"></a>五、docker stack</h1><h2 id="5-1-docker-stack介绍"><a href="#5-1-docker-stack介绍" class="headerlink" title="5.1 docker stack介绍"></a>5.1 docker stack介绍</h2><p>早期使用service发布，每次只能发布一个service。</p>
<p>yaml可以发布多个服务，但是使用docker-compose只能在一台主机发布。</p>
<p>一个stack就是一组有关联的服务的组合，可以一起编排，一起发布, 一起管理</p>
<h2 id="5-2-docker-stack与docker-compose区别"><a href="#5-2-docker-stack与docker-compose区别" class="headerlink" title="5.2 docker stack与docker compose区别"></a>5.2 docker stack与docker compose区别</h2><ul>
<li>Docker stack会忽略了“构建”指令，无法使用stack命令构建新镜像，它是需要镜像是预先已经构建好的。 所以docker-compose更适合于开发场景；</li>
<li>Docker Compose是一个Python项目，在内部，它使用Docker API规范来操作容器。所以需要安装Docker -compose，以便与Docker一起在您的计算机上使用；</li>
<li>Docker Stack功能包含在Docker引擎中。你不需要安装额外的包来使用它，docker stacks 只是swarm mode的一部分。</li>
<li>Docker stack不支持基于第2版写的docker-compose.yml ，也就是version版本至少为3。然而Docker Compose对版本为2和3的 文件仍然可以处理；</li>
<li>docker stack把docker compose的所有工作都做完了，因此docker stack将占主导地位。同时，对于大多数用户来说，切换到使用docker stack既不困难，也不需要太多的开销。如果您是Docker新手，或正在选择用于新项目的技术，请使用docker stack。</li>
</ul>
<h2 id="5-3-docker-stack常用命令"><a href="#5-3-docker-stack常用命令" class="headerlink" title="5.3 docker stack常用命令"></a>5.3 docker stack常用命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>docker stack deploy</td>
<td>部署新的堆栈或更新现有堆栈</td>
</tr>
<tr>
<td>docker stack ls</td>
<td>列出现有堆栈</td>
</tr>
<tr>
<td>docker stack ps</td>
<td>列出堆栈中的任务</td>
</tr>
<tr>
<td>docker stack rm</td>
<td>删除一个或多个堆栈</td>
</tr>
<tr>
<td>docker stack services</td>
<td>列出堆栈中的服务</td>
</tr>
</tbody></table>
<h2 id="5-4-部署wordpress案例"><a href="#5-4-部署wordpress案例" class="headerlink" title="5.4 部署wordpress案例"></a>5.4 部署wordpress案例</h2><p>1, 编写YAML文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># vim stack1.yaml</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># cat stack1.yaml</span></span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mysql:<span class="number">5.7</span></span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: somewordpress</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">      MYSQL_USER: wordpress</span><br><span class="line">      MYSQL_PASSWORD: wordpress</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  wordpress:</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8010:80&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: db:<span class="number">3306</span></span><br><span class="line">      WORDPRESS_DB_USER: wordpress</span><br><span class="line">      WORDPRESS_DB_PASSWORD: wordpress</span><br><span class="line">      WORDPRESS_DB_NAME: wordpress</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      placement:</span><br><span class="line">        constraints: [<span class="type">node.role</span> == <span class="type">manager</span>]</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li>placement的constraints限制此容器在manager节点</li>
</ul>
<p>2, 使用docker stack发布</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker stack deploy -c stack1.yaml stack1</span></span><br><span class="line">Creating network stack1_default						创建自建的overlay网络</span><br><span class="line">Creating service stack1_db							创建stack1_db服务</span><br><span class="line">Creating service stack1_wordpress					创建stack1_wordpress服务</span><br></pre></td></tr></table></figure>

<p><strong>如果报错,使用<code>docker stack rm stack1</code>删除.排完错再启动</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker stack ls</span></span><br><span class="line">NAME      SERVICES   ORCHESTRATOR</span><br><span class="line">stack1    <span class="number">2</span>          Swarm</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker service ls</span></span><br><span class="line">ID             NAME               MODE         REPLICAS   IMAGE              PORTS</span><br><span class="line">tw1a8rnde2yr   stack1_db          replicated   <span class="number">1</span>/<span class="number">1</span>        mysql:<span class="number">5.7</span></span><br><span class="line">zf1h2r4m12li   stack1_wordpress   replicated   <span class="number">1</span>/<span class="number">1</span>        wordpress:latest   *:<span class="number">8010</span>-&gt;<span class="number">80</span>/tcp</span><br></pre></td></tr></table></figure>







<p>3, 验证</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102033645.png" alt="image-20220217102033645"></p>
<h2 id="5-5-部署nginx与web管理服务案例"><a href="#5-5-部署nginx与web管理服务案例" class="headerlink" title="5.5  部署nginx与web管理服务案例"></a>5.5  部署nginx与web管理服务案例</h2><p>1, 编写YAML文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># vim stack2.yaml</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># cat stack2.yaml</span></span><br><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">80</span>:<span class="number">80</span></span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  visualizer:</span><br><span class="line">    image: dockersamples/visualizer</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9001:8080&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span><br><span class="line">    deploy:</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      placement:</span><br><span class="line">        constraints: [<span class="type">node.role</span> == <span class="type">manager</span>]</span><br><span class="line"></span><br><span class="line">  portainer:</span><br><span class="line">    image: portainer/portainer</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span><br><span class="line">    deploy:</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      placement:</span><br><span class="line">        constraints: [<span class="type">node.role</span> == <span class="type">manager</span>]</span><br></pre></td></tr></table></figure>

<p>说明: stack中共有3个service</p>
<ul>
<li>nginx服务,3个副本</li>
<li>visualizer服务: 图形查看docker swarm集群</li>
<li>portainer服务: 图形管理docker swarm集群</li>
</ul>
<p>2,使用docker stack发布</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker stack deploy -c stack2.yaml stack2</span></span><br><span class="line">Creating network stack2_default</span><br><span class="line">Creating service stack2_portainer</span><br><span class="line">Creating service stack2_nginx</span><br><span class="line">Creating service stack2_visualizer</span><br><span class="line"></span><br><span class="line">如果报错,使用docker stack <span class="built_in">rm</span> stack2删除.排完错再启动</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># docker stack ps stack2</span></span><br><span class="line">ID             NAME                  IMAGE                             NODE      DESIRED STATE   CURRENT STATE             ERROR     PORTS</span><br><span class="line">zpkt1780g2nr   stack2_nginx.<span class="number">1</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1    sm2       Running         Running <span class="number">54</span> seconds ago</span><br><span class="line"><span class="number">9</span>iqdgw2fxk0s   stack2_nginx.<span class="number">2</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1    sm3       Running         Running <span class="number">54</span> seconds ago</span><br><span class="line"><span class="number">4</span>h0ob7b4ho2a   stack2_nginx.<span class="number">3</span>        <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1    sw2       Running         Running <span class="number">54</span> seconds ago</span><br><span class="line">jpp7h6qheh4j   stack2_portainer.<span class="number">1</span>    portainer/portainer:latest        sm1       Running         Running <span class="number">21</span> seconds ago</span><br><span class="line">ty0mktx60typ   stack2_visualizer.<span class="number">1</span>   dockersamples/visualizer:latest   sm1       Running         Starting <span class="number">22</span> seconds ago</span><br></pre></td></tr></table></figure>





<p>3,验证</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102606092.png" alt="image-20220217102606092"></p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217102654303.png" alt="image-20220217102654303"></p>
<h2 id="5-6-nginx-haproxy-nfs案例"><a href="#5-6-nginx-haproxy-nfs案例" class="headerlink" title="5.6 nginx+haproxy+nfs案例"></a>5.6 nginx+haproxy+nfs案例</h2><p>1,在docker swarm管理节点上准备配置文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># mkdir -p /docker-stack/haproxy</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> ~]<span class="comment"># cd /docker-stack/haproxy/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> <span class="type">haproxy</span>]<span class="comment"># vim haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">  log <span class="number">127.0</span>.<span class="number">0.1</span> local0</span><br><span class="line">  log <span class="number">127.0</span>.<span class="number">0.1</span> local1 notice</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log global</span><br><span class="line">  mode http</span><br><span class="line">  option httplog</span><br><span class="line">  option dontlognull</span><br><span class="line">  timeout connect <span class="number">5000</span>ms</span><br><span class="line">  timeout client <span class="number">50000</span>ms</span><br><span class="line">  timeout server <span class="number">50000</span>ms</span><br><span class="line">  stats uri /status</span><br><span class="line"></span><br><span class="line">frontend balancer</span><br><span class="line">    bind *:<span class="number">8080</span></span><br><span class="line">    mode http</span><br><span class="line">    default_backend web_backends</span><br><span class="line"></span><br><span class="line">backend web_backends</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server web1 nginx1:<span class="number">80</span> check</span><br><span class="line">    server web2 nginx2:<span class="number">80</span> check</span><br><span class="line">    server web3 nginx3:<span class="number">80</span> check</span><br><span class="line">    option httpchk GET /</span><br><span class="line">    http<span class="literal">-check</span> expect status <span class="number">200</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2, 编写YAML编排文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> <span class="type">haproxy</span>]<span class="comment"># vim stack3.yml</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> <span class="type">haproxy</span>]<span class="comment"># vim stack3.yaml</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> <span class="type">haproxy</span>]<span class="comment"># cat stack3.yaml</span></span><br><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line">services:</span><br><span class="line">  nginx1:</span><br><span class="line">    image: <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on<span class="literal">-failure</span></span><br><span class="line">    volumes:</span><br><span class="line">    - <span class="string">&quot;nginx_vol:/usr/share/nginx/html&quot;</span></span><br><span class="line"></span><br><span class="line">  nginx2:</span><br><span class="line">    image: <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on<span class="literal">-failure</span></span><br><span class="line">    volumes:</span><br><span class="line">    - <span class="string">&quot;nginx_vol:/usr/share/nginx/html&quot;</span></span><br><span class="line"></span><br><span class="line">  nginx3:</span><br><span class="line">    image: <span class="number">192.168</span>.<span class="number">10.15</span>/library/nginx:v1</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on<span class="literal">-failure</span></span><br><span class="line">    volumes:</span><br><span class="line">    - <span class="string">&quot;nginx_vol:/usr/share/nginx/html&quot;</span></span><br><span class="line"></span><br><span class="line">  haproxy:</span><br><span class="line">    image: haproxy:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro&quot;</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    deploy:</span><br><span class="line">      replicas: <span class="number">1</span></span><br><span class="line">      placement:</span><br><span class="line">        constraints: [<span class="type">node.role</span> == <span class="type">manager</span>]</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  nginx_vol:</span><br><span class="line">    driver: local</span><br><span class="line">    driver_opts:</span><br><span class="line">      <span class="built_in">type</span>: <span class="string">&quot;nfs&quot;</span></span><br><span class="line">      o: <span class="string">&quot;addr=192.168.10.15,rw&quot;</span></span><br><span class="line">      device: <span class="string">&quot;:/opt/dockervolume&quot;</span></span><br></pre></td></tr></table></figure>

<p>3, 发布</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">sm1</span> <span class="type">haproxy</span>]<span class="comment"># docker stack deploy -c stack3.yml stack3</span></span><br><span class="line">Creating network stack3_default</span><br><span class="line">Creating service stack3_nginx3</span><br><span class="line">Creating service stack3_haproxy</span><br><span class="line">Creating service stack3_nginx1</span><br><span class="line">Creating service stack3_nginx2</span><br></pre></td></tr></table></figure>

<p>4, 验证</p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217120725646.png" alt="image-20220217120725646"></p>
<p><img src="/images/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96%E6%96%B9%E6%A1%88DockerSwarm.assets/image-20220217120746215.png" alt="image-20220217120746215"></p>

  </div>
</article>





    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>  
    <div id="vcomments" class="blog-post-comments"></div>
    <script>        
        new Valine({
            el: '#vcomments',
            visitor: true,
            appId: 'gqmHGHyrnzRPUSxqADLhUzlT-gzGzoHsz',
            appKey: 'q8uQ7rKeukTuQ3L35peaOhkC',
            placeholder: '好哥哥，说几句吧！',
            avatar: 'retro'
        })
    </script>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81docker-swarm%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">一、docker swarm介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81docker-swarm%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">二、docker swarm概念与架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 概念</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81docker-swarm%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">三、docker swarm集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Harbor%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 容器镜像仓库 Harbor准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%B8%BB%E6%9C%BA%E5%87%86%E5%A4%87"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 主机准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 主机名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-IP%E5%9C%B0%E5%9D%80"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 IP地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%B8%8EIP%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 主机名与IP地址解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E4%B8%BB%E6%9C%BA%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.3.4 主机时间同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.2.5 主机安全设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 docker安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.3.1 docker安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E9%85%8D%E7%BD%AEdocker-daemon%E4%BD%BF%E7%94%A8harbor"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.3.2 配置docker daemon使用harbor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-docker-swarm%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 docker swarm集群初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E8%8E%B7%E5%8F%96docker-swarm%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 获取docker swarm命令帮助</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E5%9C%A8%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 在管理节点初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 添加工作节点到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 添加管理节点到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5-%E6%A8%A1%E6%8B%9F%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%87%BA%E7%8E%B0%E6%95%85%E9%9A%9C"><span class="toc-number">3.4.5.</span> <span class="toc-text">3.4.5 模拟管理节点出现故障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-5-1-%E5%81%9C%E6%AD%A2docker%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.5.1.</span> <span class="toc-text">3.4.5.1 停止docker服务并查看结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-5-2-%E5%90%AF%E5%8A%A8docker%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.5.2.</span> <span class="toc-text">3.4.5.2 启动docker服务并查看结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81docker-swarm%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">四、docker swarm集群应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%87%86%E5%A4%87"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 容器镜像准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-v1%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 v1版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-v2%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 v2版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 发布服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E4%BD%BF%E7%94%A8docker-service-ls%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 使用docker service ls查看服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 发布服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 查看已发布服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 查看已发布服务容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-%E8%AE%BF%E9%97%AE%E5%B7%B2%E5%8F%91%E5%B8%83%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.5.</span> <span class="toc-text">4.2.5 访问已发布的服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%9C%8D%E5%8A%A1%E6%89%A9%E5%B1%95"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 服务扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%9C%8D%E5%8A%A1%E8%A3%81%E5%87%8F"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 服务裁减</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.6.</span> <span class="toc-text">4.6  删除服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 服务版本更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E5%9B%9E%E9%80%80"><span class="toc-number">4.8.</span> <span class="toc-text">4.8 服务版本回退</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E6%BB%9A%E5%8A%A8%E9%97%B4%E9%9A%94%E6%9B%B4%E6%96%B0"><span class="toc-number">4.9.</span> <span class="toc-text">4.9 服务版本滚动间隔更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-%E5%89%AF%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">4.10.</span> <span class="toc-text">4.10 副本控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11-%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.11.</span> <span class="toc-text">4.11 在指定网络中发布服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12-%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.12.</span> <span class="toc-text">4.12 服务网络模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-13-%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.</span> <span class="toc-text">4.13 服务数据持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-1-%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.1.</span> <span class="toc-text">4.13.1 本地存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-1-%E5%9C%A8%E9%9B%86%E7%BE%A4%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E4%B8%8A%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.13.1.1.</span> <span class="toc-text">4.13.1.1 在集群所有主机上创建本地目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-2-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%E6%97%B6%E6%8C%82%E8%BD%BD%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95%E5%88%B0%E5%AE%B9%E5%99%A8%E4%B8%AD"><span class="toc-number">4.13.1.2.</span> <span class="toc-text">4.13.1.2 发布服务时挂载本地目录到容器中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-1-3-%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.13.1.3.</span> <span class="toc-text">4.13.1.3 验证是否使用本地目录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-2-%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.2.</span> <span class="toc-text">4.13.2 网络存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-1-%E9%83%A8%E7%BD%B2NFS%E5%AD%98%E5%82%A8"><span class="toc-number">4.13.2.1.</span> <span class="toc-text">4.13.2.1 部署NFS存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-2-%E4%B8%BA%E9%9B%86%E7%BE%A4%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E5%AE%89%E8%A3%85nfs-utils%E8%BD%AF%E4%BB%B6"><span class="toc-number">4.13.2.2.</span> <span class="toc-text">4.13.2.2 为集群所有主机安装nfs-utils软件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-3-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">4.13.2.3.</span> <span class="toc-text">4.13.2.3 创建存储卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-4-%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.13.2.4.</span> <span class="toc-text">4.13.2.4 发布服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-2-5-%E9%AA%8C%E8%AF%81"><span class="toc-number">4.13.2.5.</span> <span class="toc-text">4.13.2.5 验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14-%E6%9C%8D%E5%8A%A1%E4%BA%92%E8%81%94%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">4.14.</span> <span class="toc-text">4.14 服务互联与服务发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-15-docker-swarm%E7%BD%91%E7%BB%9C"><span class="toc-number">4.15.</span> <span class="toc-text">4.15 docker swarm网络</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81docker-stack"><span class="toc-number">5.</span> <span class="toc-text">五、docker stack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-docker-stack%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 docker stack介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-docker-stack%E4%B8%8Edocker-compose%E5%8C%BA%E5%88%AB"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 docker stack与docker compose区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-docker-stack%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 docker stack常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E9%83%A8%E7%BD%B2wordpress%E6%A1%88%E4%BE%8B"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 部署wordpress案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E9%83%A8%E7%BD%B2nginx%E4%B8%8Eweb%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">5.5.</span> <span class="toc-text">5.5  部署nginx与web管理服务案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-nginx-haproxy-nfs%E6%A1%88%E4%BE%8B"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 nginx+haproxy+nfs案例</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&text=Docker主机集群化方案Docker Swarm"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&is_video=false&description=Docker主机集群化方案Docker Swarm"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker主机集群化方案Docker Swarm&body=Check out this article: https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&title=Docker主机集群化方案Docker Swarm"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fate-re-zero.github.io/2023/08/17/%E4%BA%91%E5%8E%9F%E7%94%9F/Docker/Docker%E4%B8%BB%E6%9C%BA%E9%9B%86%E7%BE%A4%E5%8C%96Docker%20Swarm/&name=Docker主机集群化方案Docker Swarm&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">2025 祥祥要起飞</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/lib/particles/particles.min.js"></script>


<script src="/lib/typing/typing.min.js"></script>


<script src="/js/main.js"></script>


<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


