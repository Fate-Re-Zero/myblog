<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="一、 service作用使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes核心概念Service">
<meta property="og:url" content="https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/index.html">
<meta property="og:site_name" content="祥祥要起飞">
<meta property="og:description" content="一、 service作用使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102113765.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-userspace.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102306186.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-iptables.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102614692.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-ipvs.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20200531203549337.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20200531203510735.png">
<meta property="og:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402101421824.png">
<meta property="article:published_time" content="2024-03-29T00:40:46.000Z">
<meta property="article:modified_time" content="2025-04-24T15:04:51.126Z">
<meta property="article:author" content="祥祥要起飞">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fate-re-zero.github.io/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102113765.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>kubernetes核心概念Service</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="祥祥要起飞" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2024/04/06/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes%E9%9B%86%E7%BE%A4Node%E7%AE%A1%E7%90%86/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2024/03/18/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/Kubernetes%E9%9B%86%E7%BE%A4%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88Namespace%EF%BC%89/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&text=kubernetes核心概念Service"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&is_video=false&description=kubernetes核心概念Service"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kubernetes核心概念Service&body=Check out this article: https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&name=kubernetes核心概念Service&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81-service%E4%BD%9C%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">一、 service作用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81kube-proxy%E4%B8%89%E7%A7%8D%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">二、kube-proxy三种代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-UserSpace%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 UserSpace模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-iptables%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 iptables模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-ipvs%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 ipvs模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-iptables%E4%B8%8Eipvs%E5%AF%B9%E6%AF%94"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 iptables与ipvs对比</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81-service%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">三、 service类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-service%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 service类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Service%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Service参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-Service%E5%88%9B%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">四、 Service创建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ClusterIP%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ClusterIP类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E6%99%AE%E9%80%9AClusterIP-Service%E5%88%9B%E5%BB%BA"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 普通ClusterIP Service创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-1-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%9B%E5%BB%BAService"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">4.1.1.1 命令行创建Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-2-%E9%80%9A%E8%BF%87%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAService"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">4.1.1.2 通过资源清单文件创建Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-3-%E8%AE%BF%E9%97%AE"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">4.1.1.3 访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-4-%E4%B8%A4%E4%B8%AApod%E9%87%8C%E5%81%9A%E6%88%90%E4%B8%8D%E5%90%8C%E7%9A%84%E4%B8%BB%E9%A1%B5%E6%96%B9%E4%BE%BF%E6%B5%8B%E8%AF%95%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.1.1.4.</span> <span class="toc-text">4.1.1.4 两个pod里做成不同的主页方便测试负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.1.5.</span> <span class="toc-text">4.1.1.5 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-Headless-Service"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 Headless Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-1-%E7%BC%96%E5%86%99%E7%94%A8%E4%BA%8E%E5%88%9B%E5%BB%BADeployment%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-2-%E9%80%9A%E8%BF%87%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAheadless-Service"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">4.1.2.2 通过资源清单文件创建headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-3-%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAheadless-Service"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">4.1.2.3 应用资源清单文件创建headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-4-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%88%9B%E5%BB%BA%E7%9A%84headless-Service"><span class="toc-number">4.1.2.4.</span> <span class="toc-text">4.1.2.4 查看已创建的headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-5-DNS"><span class="toc-number">4.1.2.5.</span> <span class="toc-text">4.1.2.5 DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-1-%E6%9F%A5%E7%9C%8Bkube-dns%E6%9C%8D%E5%8A%A1%E7%9A%84IP"><span class="toc-number">4.1.2.5.1.</span> <span class="toc-text">4.1.2.5.1 查看kube-dns服务的IP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-2-%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87DNS%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E6%9F%A5%E6%89%BE%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E7%9A%84dns%E8%A7%A3%E6%9E%90"><span class="toc-number">4.1.2.5.2.</span> <span class="toc-text">4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-3-%E9%AA%8C%E8%AF%81pod%E7%9A%84IP"><span class="toc-number">4.1.2.5.3.</span> <span class="toc-text">4.1.2.5.3  验证pod的IP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-4-%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApod%E9%AA%8C%E8%AF%81"><span class="toc-number">4.1.2.5.4.</span> <span class="toc-text">4.1.2.5.4 在集群中创建一个pod验证</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-NodePort%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 NodePort类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-LoadBalancer"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 LoadBalancer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E9%9B%86%E7%BE%A4%E5%A4%96%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 集群外访问过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E5%95%86%E6%8F%90%E4%BE%9BLB%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">云服务提供商提供LB服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodeIP-Port-service-IP"><span class="toc-number">4.3.1.4.</span> <span class="toc-text">NodeIP:Port(service IP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod-IP%EF%BC%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">4.3.1.5.</span> <span class="toc-text">Pod IP：端口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E8%87%AA%E5%BB%BAKubernetes%E7%9A%84LoadBalancer%E7%B1%BB%E5%9E%8B%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%A1%88-MetalLB"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-1-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">4.3.2.1  参考资料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-2-%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">4.3.2.2  应用资源清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-3-%E5%87%86%E5%A4%87metallb%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.3.</span> <span class="toc-text">4.3.2.3 准备metallb配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-4%E5%8F%91%E5%B8%83Service%E7%B1%BB%E5%9E%8B%E4%B8%BALoadBalancer%E7%9A%84Deployment%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-number">4.3.2.4.</span> <span class="toc-text">4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-5-%E9%AA%8C%E8%AF%81"><span class="toc-number">4.3.2.5.</span> <span class="toc-text">4.3.2.5 验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-6-%E8%AE%BF%E9%97%AE"><span class="toc-number">4.3.2.6.</span> <span class="toc-text">4.3.2.6 访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-ExternalName"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 ExternalName</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-ExternalName%E4%BD%9C%E7%94%A8"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 ExternalName作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E5%B0%86%E5%85%AC%E7%BD%91%E5%9F%9F%E5%90%8D%E5%BC%95%E5%85%A5"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.4.2   将公网域名引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E4%B8%8D%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.4.3 不同命名空间访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81sessionAffinity"><span class="toc-number">5.</span> <span class="toc-text">五、sessionAffinity</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BF%AE%E6%94%B9%E4%B8%BAipvs%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F%EF%BC%88%E6%8B%93%E5%B1%95%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">六、修改为ipvs调度方式（拓展）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BF%AE%E6%94%B9%E4%B8%BAIPVS%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F%E5%89%8D%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 修改为IPVS调度方式前升级内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BF%AE%E6%94%B9kube-proxy%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 修改kube-proxy的配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%9F%A5%E7%9C%8Bkube-system%E7%9A%84namespace%E4%B8%ADkube-proxy%E6%9C%89%E5%85%B3%E7%9A%84pod"><span class="toc-number">6.3.</span> <span class="toc-text">6.3  查看kube-system的namespace中kube-proxy有关的pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E9%AA%8C%E8%AF%81kube-proxy-xxx%E7%9A%84pod%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 验证kube-proxy-xxx的pod中的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8kube-proxy"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 重新启动kube-proxy</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        kubernetes核心概念Service
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">祥祥要起飞</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-29T00:40:46.000Z" itemprop="datePublished">2024-03-29</time>
        
      
    </div>


      <div class="posteye">
    <i class="fas fa-eye"></i>
    <span id="/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/" class="leancloud-visitors" data-flag-title="kubernetes核心概念Service" style="display: inline;">
        <span class="leancloud-visitors-count"></span>
    </span>
</div>
      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="一、-service作用"><a href="#一、-service作用" class="headerlink" title="一、 service作用"></a>一、 service作用</h1><p>使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。</p>
<ul>
<li>通过service为pod客户端提供访问pod方法，即可客户端访问pod入口</li>
<li>通过标签动态感知pod IP地址变化等</li>
<li>防止pod失联</li>
<li>定义访问pod访问策略</li>
<li>通过label-selector相关联</li>
<li>通过Service实现Pod的负载均衡（TCP/UDP 4层）</li>
<li>底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式</li>
</ul>
<h1 id="二、kube-proxy三种代理模式"><a href="#二、kube-proxy三种代理模式" class="headerlink" title="二、kube-proxy三种代理模式"></a>二、kube-proxy三种代理模式</h1><ul>
<li><p>kubernetes集群中有三层网络，一类是真实存在的，例如Node Network、Pod Network,提供真实IP地址;一类是虚拟的，例如Cluster Network或Service Network，提供虚拟IP地址，不会出现在接口上，仅会出现在Service当中</p>
</li>
<li><p>kube-proxy始终watch（监控）kube-apiserver上关于Service相关的资源变动状态，一旦获取相关信息kube-proxy都要把相关信息转化为当前节点之上的，能够实现Service资源调度到特定Pod之上的规则，进而实现访问Service就能够获取Pod所提供的服务</p>
</li>
<li><p>kube-proxy三种代理模式：UserSpace模式、iptables模式、ipvs模式</p>
</li>
</ul>
<h2 id="2-1-UserSpace模式"><a href="#2-1-UserSpace模式" class="headerlink" title="2.1 UserSpace模式"></a>2.1 UserSpace模式</h2><p>userspace 模式是 kube-proxy 使用的第一代模式，该模式在 kubernetes v1.0 版本开始支持使用。</p>
<p>userspace 模式的实现原理图示如下：</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102113765.png" alt="image-20220402102113765"></p>
<p>kube-proxy 会为每个 Service 随机监听一个端口(proxy port)，并增加一条 iptables 规则。所以通过 ClusterIP:Port 访问 Service 的报文都 redirect 到 proxy port，kube-proxy 从它监听的 proxy port 收到报文以后，走 round robin(默认) 或是 session affinity(会话亲和力，即同一 client IP 都走同一链路给同一 pod 服务)，分发给对应的 pod。</p>
<p>由于 userspace 模式会造成所有报文都走一遍用户态（也就是 Service 请求会先从用户空间进入内核 iptables，然后再回到用户空间，由 kube-proxy 完成后端 Endpoints 的选择和代理工作），需要在内核空间和用户空间转换，流量从用户空间进出内核会带来性能损耗，所以这种模式效率低、性能不高，不推荐使用。</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-userspace.png"></p>
<h2 id="2-2-iptables模式"><a href="#2-2-iptables模式" class="headerlink" title="2.2 iptables模式"></a>2.2 iptables模式</h2><p>iptables 模式是 kube-proxy 使用的第二代模式，该模式在 kubernetes v1.1 版本开始支持，从 v1.2 版本开始成为 kube-proxy 的默认模式。</p>
<p>iptables 模式的负载均衡模式是通过底层 netfilter/iptables 规则来实现的，通过 Informer 机制 Watch 接口实时跟踪 Service 和 Endpoint 的变更事件，并触发对 iptables 规则的同步更新。</p>
<p>iptables 模式的实现原理图示如下：</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102306186.png" alt="image-20220402102306186"></p>
<p>通过图示我们可以发现在 iptables 模式下，kube-proxy 只是作为 controller，而不是 server，真正服务的是内核的 netfilter，体现在用户态的是 iptables。所以整体的效率会比 userspace 模式高。</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-iptables.png"></p>
<h2 id="2-3-ipvs模式"><a href="#2-3-ipvs模式" class="headerlink" title="2.3 ipvs模式"></a>2.3 ipvs模式</h2><p>ipvs 模式被 kube-proxy 采纳为第三代模式，模式在 kubernetes v1.8 版本开始引入，在 v1.9 版本中处于 beta 阶段，在 v1.11 版本中正式开始使用。</p>
<p>ipvs(IP Virtual Server) 实现了传输层负载均衡，也就是 4 层交换，作为 Linux 内核的一部分。<code>ipvs</code>运行在主机上，在真实服务器前充当负载均衡器。ipvs 可以将基于 TCP 和 UDP 的服务请求转发到真实服务器上，并使真实服务器上的服务在单个 IP 地址上显示为虚拟服务。</p>
<p>ipvs 模式的实现原理图示如下：</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402102614692.png" alt="image-20220402102614692"></p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/service-ipvs.png"></p>
<p>ipvs 和 iptables 都是基于 netfilter 的，那么 ipvs 模式有哪些更好的性能呢？</p>
<ul>
<li>ipvs 为大型集群提供了更好的可拓展性和性能</li>
<li>ipvs 支持比 iptables 更复杂的负载均衡算法（包括：最小负载、最少连接、加权等）</li>
<li>ipvs 支持服务器健康检查和连接重试等功能</li>
<li>可以动态修改 ipset 的集合，即使 iptables 的规则正在使用这个集合</li>
</ul>
<p>ipvs 依赖于 iptables。ipvs 会使用 iptables 进行包过滤、airpin-masquerade tricks(地址伪装)、SNAT 等功能，但是使用的是 iptables 的扩展 ipset，并不是直接调用 iptables 来生成规则链。通过 ipset 来存储需要 DROP 或 masquerade 的流量的源或目标地址，用于确保 iptables 规则的数量是恒定的，这样我们就不需要关心有多少 Service 或是 Pod 了。</p>
<p>使用 ipset 相较于 iptables 有什么优点呢？iptables 是线性的数据结构，而 ipset 引入了带索引的数据结构，当规则很多的时候，ipset 依然可以很高效的查找和匹配。我们可以将 ipset 简单理解为一个 IP(段) 的集合，这个集合的内容可以是 IP 地址、IP 网段、端口等，iptables 可以直接添加规则对这个“可变的集合进行操作”，这样就可以大大减少 iptables 规则的数量，从而减少性能损耗。</p>
<p>举一个例子，如果我们要禁止成千上万个 IP 访问我们的服务器，如果使用 iptables 就需要一条一条的添加规则，这样会在 iptables 中生成大量的规则；如果用 ipset 就只需要将相关的 IP 地址(网段)加入到 ipset 集合中，然后只需要设置少量的 iptables 规则就可以实现这个目标。</p>
<p>下面的表格是 ipvs 模式下维护的 ipset 表集合：</p>
<table>
<thead>
<tr>
<th align="left">设置名称</th>
<th align="left">成员</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">KUBE-CLUSTER-IP</td>
<td align="left">所有服务 IP + 端口</td>
<td align="left">在 masquerade-all=true 或 clusterCIDR 指定的情况下对 Service Cluster IP 地址进行伪装，解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-LOOP-BACK</td>
<td align="left">所有服务 IP + 端口 + IP</td>
<td align="left">解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-EXTERNAL-IP</td>
<td align="left">服务外部 IP + 端口</td>
<td align="left">将数据包伪装成 Service 的外部 IP 地址</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER</td>
<td align="left">负载均衡器入口 IP + 端口</td>
<td align="left">将数据包伪装成 Load Balancer 类型的 Service</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-LOCAL</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 Load Balancer externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-FW</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>loadBalancerSourceRanges</code></td>
<td align="left">使用指定的 loadBalancerSourceRanges 丢弃 Load Balancer 类型 Service 的数据包</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-SOURCE-CIDR</td>
<td align="left">负载均衡器入口 IP + 端口 + 源 CIDR</td>
<td align="left">接受 Load Balancer 类型 Service 的数据包，并指定 loadBalancerSourceRanges</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口</td>
<td align="left">将数据包伪装成 NodePort（TCP）</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口，带有<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口</td>
<td align="left">将数据包伪装成 NodePort(UDP)</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口，使用<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
</tbody></table>
<h2 id="2-4-iptables与ipvs对比"><a href="#2-4-iptables与ipvs对比" class="headerlink" title="2.4 iptables与ipvs对比"></a>2.4 iptables与ipvs对比</h2><ul>
<li>iptables<ul>
<li>工作在内核空间</li>
<li>优点<ul>
<li>灵活，功能强大（可以在数据包不同阶段对包进行操作）</li>
</ul>
</li>
<li>缺点<ul>
<li>表中规则过多时，响应变慢，即规则遍历匹配和更新，呈线性时延</li>
</ul>
</li>
</ul>
</li>
<li>ipvs<ul>
<li>工作在内核空间</li>
<li>优点<ul>
<li>转发效率高</li>
<li>调度算法丰富：rr，wrr，lc，wlc，ip hash…</li>
</ul>
</li>
<li>缺点<ul>
<li>内核支持不全,低版本内核不能使用，需要升级到4.0或5.0以上。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>使用iptables与ipvs时机<ul>
<li>1.10版本之前使用iptables(1.1版本之前使用UserSpace进行转发)</li>
<li>1.11版本之后同时支持iptables与ipvs，默认使用ipvs，如果ipvs模块没有加载时，会自动降级至iptables</li>
</ul>
</li>
</ul>
<h1 id="三、-service类型"><a href="#三、-service类型" class="headerlink" title="三、 service类型"></a>三、 service类型</h1><p>Service类型决定了访问Service的方法</p>
<h2 id="3-1-service类型"><a href="#3-1-service类型" class="headerlink" title="3.1 service类型"></a>3.1 service类型</h2><ul>
<li><p>ClusterIP</p>
<ul>
<li>默认，分配一个集群内部可以访问的虚拟IP</li>
</ul>
</li>
<li><p>NodePort</p>
<ul>
<li>在每个Node上分配一个端口作为外部访问入口</li>
<li>nodePort端口范围为:30000-32767</li>
</ul>
</li>
<li><p>LoadBalancer</p>
<ul>
<li>工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack</li>
</ul>
</li>
<li><p>ExternalName</p>
<ul>
<li>表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信</li>
</ul>
</li>
</ul>
<h2 id="3-2-Service参数"><a href="#3-2-Service参数" class="headerlink" title="3.2 Service参数"></a>3.2 Service参数</h2><ul>
<li><p>port             访问service使用的端口</p>
</li>
<li><p>targetPort  Pod中容器端口</p>
</li>
<li><p>nodePort   通过Node实现外网用户访问k8s集群内service (30000-32767)</p>
</li>
</ul>
<h1 id="四、-Service创建"><a href="#四、-Service创建" class="headerlink" title="四、 Service创建"></a>四、 Service创建</h1><blockquote>
<p>Service的创建在工作中有两种方式，一是命令行创建，二是通过资源清单文件YAML文件创建。</p>
</blockquote>
<h2 id="4-1-ClusterIP类型"><a href="#4-1-ClusterIP类型" class="headerlink" title="4.1 ClusterIP类型"></a>4.1 ClusterIP类型</h2><p>ClusterIP根据是否生成ClusterIP又可分为普通Service和Headless Service</p>
<p>Service两类：</p>
<ul>
<li>普通Service: </li>
</ul>
<p>为Kubernetes的Service分配一个集群内部可访问的固定虚拟IP(Cluster IP), 实现集群内的访问。</p>
<ul>
<li>Headless Service: </li>
</ul>
<p>该服务不会分配Cluster IP, 也不通过kube-proxy做反向代理和负载均衡。而是通过DNS提供稳定的网络ID来访问，DNS会将headless service的后端直接解析为pod IP列表。</p>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20200531203549337.png" alt="image-20200531203549337"></p>
<h3 id="4-1-1-普通ClusterIP-Service创建"><a href="#4-1-1-普通ClusterIP-Service创建" class="headerlink" title="4.1.1 普通ClusterIP Service创建"></a>4.1.1 普通ClusterIP Service创建</h3><h4 id="4-1-1-1-命令行创建Service"><a href="#4-1-1-1-命令行创建Service" class="headerlink" title="4.1.1.1 命令行创建Service"></a>4.1.1.1 命令行创建Service</h4><ul>
<li>创建Deployment类型的应用</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># cat 01_create_deployment_app_nginx.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-server1</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: c1</span><br><span class="line">         image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: <span class="number">80</span></span><br></pre></td></tr></table></figure>



<ul>
<li>应用资源清单文件</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f 01_create_deployment_app_nginx.yaml</span></span><br></pre></td></tr></table></figure>



<ul>
<li>验证Deployment类型的创建情况</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get deployment.apps</span></span><br><span class="line">NAME            READY   UP<span class="literal">-TO</span><span class="literal">-DATE</span>   AVAILABLE   AGE</span><br><span class="line">nginx<span class="literal">-server1</span>   <span class="number">2</span>/<span class="number">2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="number">13</span>s</span><br></pre></td></tr></table></figure>



<ul>
<li>创建ClusterIP类型service与Deployment类型应用关联</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令创建service</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl expose deployment.apps nginx-server1 --type=ClusterIP --target-port=80 --port=80</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输出</span><br><span class="line">service/nginx<span class="literal">-server1</span> exposed</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">说明</span><br><span class="line">expose 创建service</span><br><span class="line">deployment.apps 控制器类型</span><br><span class="line">nginx<span class="literal">-server1</span> 应用名称，也是service名称</span><br><span class="line">-<span class="literal">-type</span>=ClusterIP 指定service类型</span><br><span class="line">-<span class="literal">-target</span><span class="literal">-port</span>=<span class="number">80</span> 指定Pod中容器端口</span><br><span class="line">-<span class="literal">-port</span>=<span class="number">80</span> 指定service端口</span><br></pre></td></tr></table></figure>





<h4 id="4-1-1-2-通过资源清单文件创建Service"><a href="#4-1-1-2-通过资源清单文件创建Service" class="headerlink" title="4.1.1.2 通过资源清单文件创建Service"></a>4.1.1.2 通过资源清单文件创建Service</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-server1</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: nginx<span class="literal">-smart</span></span><br><span class="line">         image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-svc</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: <span class="number">80</span></span><br><span class="line">    targetPort: <span class="number">80</span></span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl  apply -f 02_create_deployment_app_nginx_with_service.yaml</span></span><br></pre></td></tr></table></figure>



<ul>
<li>验证</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看service</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get service</span></span><br><span class="line">NAME         <span class="built_in">TYPE</span>        CLUSTER<span class="literal">-IP</span>       EXTERNAL<span class="literal">-IP</span>   PORT(S)    AGE</span><br><span class="line">kubernetes   ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>        &lt;none&gt;        <span class="number">443</span>/TCP    <span class="number">4</span>d15<span class="built_in">h</span></span><br><span class="line">nginx<span class="literal">-svc</span>    ClusterIP   <span class="number">10.101</span>.<span class="number">153.50</span>   &lt;none&gt;        <span class="number">80</span>/TCP    <span class="number">3</span>s</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看endpoints</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME         ENDPOINTS                            AGE</span><br><span class="line">kubernetes   <span class="number">192.168</span>.<span class="number">122.30</span>:<span class="number">6443</span>                  <span class="number">4</span>d15<span class="built_in">h</span></span><br><span class="line">nginx<span class="literal">-svc</span>    <span class="number">172.16</span>.<span class="number">189.74</span>:<span class="number">80</span>,<span class="number">172.16</span>.<span class="number">235.150</span>:<span class="number">80</span>   <span class="number">8</span>s</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看Pod</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -l app=nginx</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx<span class="literal">-server1</span><span class="literal">-77d4c485d8</span><span class="literal">-gsrmq</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">12</span>s</span><br><span class="line">nginx<span class="literal">-server1</span><span class="literal">-77d4c485d8</span><span class="literal">-mmc52</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">12</span>s</span><br></pre></td></tr></table></figure>



<h4 id="4-1-1-3-访问"><a href="#4-1-1-3-访问" class="headerlink" title="4.1.1.3 访问"></a>4.1.1.3 访问</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl http://10.101.153.50:80</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: <span class="number">35</span>em;</span><br><span class="line">        margin: <span class="number">0</span> auto;</span><br><span class="line">        font<span class="literal">-family</span>: Tahoma, Verdana, Arial, sans<span class="literal">-serif</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;<span class="keyword">If</span> you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;<span class="keyword">For</span> online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> <span class="keyword">using</span> nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h4 id="4-1-1-4-两个pod里做成不同的主页方便测试负载均衡"><a href="#4-1-1-4-两个pod里做成不同的主页方便测试负载均衡" class="headerlink" title="4.1.1.4 两个pod里做成不同的主页方便测试负载均衡"></a>4.1.1.4 两个pod里做成不同的主页方便测试负载均衡</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-server1-77d4c485d8-gsrmq -- /bin/bash</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-nv7dn</span>:/<span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-nv7dn</span>:/usr/share/nginx/html<span class="comment"># echo web1 &gt; index.html</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-nv7dn</span>:/usr/share/nginx/html<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-server1-77d4c485d8-mmc52 -- /bin/bash</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-rqrcw</span>:/<span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-rqrcw</span>:/usr/share/nginx/html<span class="comment"># echo web2 &gt; index.html</span></span><br><span class="line">root@deployment<span class="literal">-nginx</span><span class="literal">-6fcfb67547</span><span class="literal">-rqrcw</span>:/usr/share/nginx/html<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>



<h4 id="4-1-1-5-测试"><a href="#4-1-1-5-测试" class="headerlink" title="4.1.1.5 测试"></a>4.1.1.5 测试</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl 10.101.153.50</span></span><br><span class="line">或</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># while true;do curl 10.101.153.50;sleep 1; done</span></span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-Headless-Service"><a href="#4-1-2-Headless-Service" class="headerlink" title="4.1.2 Headless Service"></a>4.1.2 Headless Service</h3><ul>
<li>普通的ClusterIP service是service name解析为cluster ip,然后cluster ip对应到后面的pod ip</li>
<li>Headless service是指service name 直接解析为后面的pod ip</li>
</ul>
<h4 id="4-1-2-1-编写用于创建Deployment控制器类型的资源清单文件"><a href="#4-1-2-1-编写用于创建Deployment控制器类型的资源清单文件" class="headerlink" title="4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件"></a>4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># cat 03_create_deployment_app_nginx.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-server1</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: nginx<span class="literal">-smart</span></span><br><span class="line">         image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: <span class="number">80</span></span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-2-通过资源清单文件创建headless-Service"><a href="#4-1-2-2-通过资源清单文件创建headless-Service" class="headerlink" title="4.1.2.2 通过资源清单文件创建headless Service"></a>4.1.2.2 通过资源清单文件创建headless Service</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">编写YAML文件</span><br><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># vim 04_headless-service.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: headless<span class="literal">-service</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP     <span class="comment"># ClusterIP类型,也是默认类型</span></span><br><span class="line">  clusterIP: None     <span class="comment"># None就代表是无头service</span></span><br><span class="line">  ports:                                <span class="comment"># 指定service 端口及容器端口</span></span><br><span class="line">  - port: <span class="number">80</span>                            <span class="comment"># service ip中的端口</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: <span class="number">80</span>                      <span class="comment"># pod中的端口</span></span><br><span class="line">  selector:                             <span class="comment"># 指定后端pod标签</span></span><br><span class="line">     app: nginx                    <span class="comment"># 可通过kubectl get pod -l app=nginx查看哪些pod在使用此标签</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-3-应用资源清单文件创建headless-Service"><a href="#4-1-2-3-应用资源清单文件创建headless-Service" class="headerlink" title="4.1.2.3 应用资源清单文件创建headless Service"></a>4.1.2.3 应用资源清单文件创建headless Service</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl apply -f 04_headless_service.yml</span></span><br><span class="line">输出</span><br><span class="line">service/headless<span class="literal">-service</span> created</span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-4-查看已创建的headless-Service"><a href="#4-1-2-4-查看已创建的headless-Service" class="headerlink" title="4.1.2.4 查看已创建的headless Service"></a>4.1.2.4 查看已创建的headless Service</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">输出</span><br><span class="line">NAME               <span class="built_in">TYPE</span>        CLUSTER<span class="literal">-IP</span>       EXTERNAL<span class="literal">-IP</span>   PORT(S)          AGE</span><br><span class="line">headless<span class="literal">-service</span>   ClusterIP   None             &lt;none&gt;        <span class="number">80</span>/TCP           <span class="number">2</span>m18s</span><br><span class="line">kubernetes         ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>        &lt;none&gt;        <span class="number">443</span>/TCP          <span class="number">5</span>d9<span class="built_in">h</span></span><br><span class="line">可以看到headless<span class="literal">-service</span>没有CLUSTER<span class="literal">-IP</span>,用None表示</span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-5-DNS"><a href="#4-1-2-5-DNS" class="headerlink" title="4.1.2.5 DNS"></a>4.1.2.5 DNS</h4><p>DNS服务监视Kubernetes API,为每一个Service创建DNS记录用于域名解析</p>
<p>headless service需要DNS来解决访问问题</p>
<p>DNS记录格式为: <service-name>.<namespace-name>.svc.cluster.local.</namespace-name></service-name></p>
<h5 id="4-1-2-5-1-查看kube-dns服务的IP"><a href="#4-1-2-5-1-查看kube-dns服务的IP" class="headerlink" title="4.1.2.5.1 查看kube-dns服务的IP"></a>4.1.2.5.1 查看kube-dns服务的IP</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master1</span> ~]<span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">NAME             <span class="built_in">TYPE</span>        CLUSTER<span class="literal">-IP</span>      EXTERNAL<span class="literal">-IP</span>   PORT(S)                  AGE</span><br><span class="line">kube<span class="literal">-dns</span>         ClusterIP   <span class="number">10.96</span>.<span class="number">0.2</span>      &lt;none&gt;        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">5</span>d9<span class="built_in">h</span></span><br><span class="line">metrics<span class="literal">-server</span>   ClusterIP   <span class="number">10.105</span>.<span class="number">219.44</span>   &lt;none&gt;        <span class="number">443</span>/TCP                  <span class="number">45</span><span class="built_in">h</span></span><br><span class="line">查看到coreDNS的服务地址是<span class="number">10.96</span>.<span class="number">0.2</span></span><br></pre></td></tr></table></figure>



<h5 id="4-1-2-5-2-在集群主机通过DNS服务地址查找无头服务的dns解析"><a href="#4-1-2-5-2-在集群主机通过DNS服务地址查找无头服务的dns解析" class="headerlink" title="4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析"></a>4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># dig -t A headless-service.default.svc.cluster.local. @10.96.0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG <span class="number">9.11</span>.<span class="number">4</span><span class="literal">-P2</span><span class="literal">-RedHat</span><span class="literal">-9</span>.<span class="number">11.4</span><span class="literal">-16</span>.P2.el7_8.<span class="number">2</span> &lt;&lt;&gt;&gt; <span class="literal">-t</span> A headless<span class="literal">-service</span>.default.svc.cluster.local. @<span class="number">10.96</span>.<span class="number">0.2</span></span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .local is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: <span class="number">31371</span></span><br><span class="line">;; flags: qr aa <span class="built_in">rd</span>; QUERY: <span class="number">1</span>, ANSWER: <span class="number">1</span>, AUTHORITY: <span class="number">0</span>, ADDITIONAL: <span class="number">1</span></span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: <span class="number">0</span>, flags:; udp: <span class="number">4096</span></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;headless<span class="literal">-service</span>.default.svc.cluster.local. <span class="keyword">IN</span> A <span class="comment">#被解析域名</span></span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">headless<span class="literal">-service</span>.default.svc.cluster.local. <span class="number">30</span> <span class="keyword">IN</span> A <span class="number">10.224</span>.<span class="number">235.147</span> <span class="comment">#注意这里IP</span></span><br><span class="line"></span><br><span class="line">;; Query time: <span class="number">0</span> msec</span><br><span class="line">;; SERVER: <span class="number">10.96</span>.<span class="number">0.10</span><span class="comment">#53(10.96.0.2)</span></span><br><span class="line">;; WHEN: Sun May <span class="number">17</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">50</span> CST <span class="number">2020</span></span><br><span class="line">;; MSG SIZE  rcvd: <span class="number">129</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="4-1-2-5-3-验证pod的IP"><a href="#4-1-2-5-3-验证pod的IP" class="headerlink" title="4.1.2.5.3  验证pod的IP"></a>4.1.2.5.3  验证pod的IP</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">输出</span><br><span class="line">NAME                                READY   STATUS             RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx<span class="literal">-deployment</span><span class="literal">-56bf6c9c8c</span><span class="literal">-jmk7r</span>   <span class="number">1</span>/<span class="number">1</span>     Running            <span class="number">0</span>          <span class="number">35</span>m   <span class="number">10.224</span>.<span class="number">235.147</span>   worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="4-1-2-5-4-在集群中创建一个pod验证"><a href="#4-1-2-5-4-在集群中创建一个pod验证" class="headerlink" title="4.1.2.5.4 在集群中创建一个pod验证"></a>4.1.2.5.4 在集群中创建一个pod验证</h5><blockquote>
<p>创建一个镜像为busyboxplus:curl的pod，pod名称为bb2,用来解析域名</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">命令</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl run bbp --image=busyboxplus:curl -it</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl run bbp --image=1.28 -it</span></span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line"><span class="keyword">If</span> you don<span class="string">&#x27;t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">解析域名</span></span><br><span class="line"><span class="string">nslookup headless-service.default.svc.cluster.local.</span></span><br><span class="line"><span class="string">访问命令</span></span><br><span class="line"><span class="string">[ root@bbp:/ ]$ curl http://headless-service.default.svc.cluster.local.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">输出</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">    body &#123;</span></span><br><span class="line"><span class="string">        width: 35em;</span></span><br><span class="line"><span class="string">        margin: 0 auto;</span></span><br><span class="line"><span class="string">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="string">working. Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;For online documentation and support please refer to</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="string">Commercial support is available at</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">[ root@bbp:/ ]$ exit</span></span><br><span class="line"><span class="string">Session ended, resume using &#x27;</span>kubectl attach bbp <span class="literal">-c</span> bbp <span class="literal">-i</span> <span class="literal">-t</span><span class="string">&#x27; command when the pod is running</span></span><br></pre></td></tr></table></figure>





<h2 id="4-2-NodePort类型"><a href="#4-2-NodePort类型" class="headerlink" title="4.2 NodePort类型"></a>4.2 NodePort类型</h2><ul>
<li>创建资源清单文件</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># cat 05_create_nodeport_service_app.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-app</span></span><br><span class="line">  labels:</span><br><span class="line">    app: nginx<span class="literal">-app</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx<span class="literal">-app</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx<span class="literal">-app</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: c1</span><br><span class="line">        image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-app</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx<span class="literal">-app</span></span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    nodePort: <span class="number">30001</span></span><br><span class="line">    port: <span class="number">8060</span></span><br><span class="line">    targetPort: <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ul>
<li>应用资源清单文件</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f 05_create_nodeport_service_app.yaml</span></span><br><span class="line">deployment.apps/nginx<span class="literal">-app</span> created</span><br><span class="line">service/nginx<span class="literal">-app</span> created</span><br></pre></td></tr></table></figure>

<ul>
<li>验证service创建</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get deployment.apps</span></span><br><span class="line">NAME         READY   UP<span class="literal">-TO</span><span class="literal">-DATE</span>   AVAILABLE   AGE</span><br><span class="line">nginx<span class="literal">-app</span>    <span class="number">2</span>/<span class="number">2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="number">26</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         <span class="built_in">TYPE</span>        CLUSTER<span class="literal">-IP</span>       EXTERNAL<span class="literal">-IP</span>   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>        &lt;none&gt;        <span class="number">443</span>/TCP          <span class="number">2</span>d22<span class="built_in">h</span></span><br><span class="line">nginx<span class="literal">-app</span>    NodePort    <span class="number">10.104</span>.<span class="number">157.20</span>    &lt;none&gt;        <span class="number">8060</span>:<span class="number">30001</span>/TCP   <span class="number">36</span>s</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get endpoints</span></span><br><span class="line">NAME         ENDPOINTS                       AGE</span><br><span class="line">kubernetes   <span class="number">192.168</span>.<span class="number">122.10</span>:<span class="number">6443</span>             <span class="number">2</span>d22<span class="built_in">h</span></span><br><span class="line">nginx<span class="literal">-app</span>    <span class="number">172.16</span>.<span class="number">1.24</span>:<span class="number">80</span>,<span class="number">172.16</span>.<span class="number">2.20</span>:<span class="number">80</span>   <span class="number">2</span>m10s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># ss -anput | grep &quot;:30001&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>      :::<span class="number">30001</span>                :::*                   users:((<span class="string">&quot;kube-proxy&quot;</span>,pid=<span class="number">5826</span>,fd=<span class="number">9</span>))</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">worker01</span> ~]<span class="comment"># ss -anput | grep &quot;:30001&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>      :::<span class="number">30001</span>                :::*                   users:((<span class="string">&quot;kube-proxy&quot;</span>,pid=<span class="number">4937</span>,fd=<span class="number">11</span>))</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">worker02</span> ~]<span class="comment"># ss -anput | grep &quot;:30001&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>      :::<span class="number">30001</span>                :::*                   users:((<span class="string">&quot;kube-proxy&quot;</span>,pid=<span class="number">5253</span>,fd=<span class="number">11</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-cnwbx</span>    <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">8</span>m59s</span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-mz77g</span>    <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">8</span>m59s</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-app-ffd5ccc78-cnwbx -- bash</span></span><br><span class="line">root@nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-cnwbx</span>:/<span class="comment"># echo &quot;nginx-app-1&quot; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-cnwbx</span>:/<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-app-ffd5ccc78-mz77g -- bash</span></span><br><span class="line">root@nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-mz77g</span>:/<span class="comment"># echo &quot;nginx-app-2&quot; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx<span class="literal">-app</span><span class="literal">-ffd5ccc78</span><span class="literal">-mz77g</span>:/<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在与kubernetes 节点同一网络主机中访问k8s集群内service</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">bogon</span> ~]<span class="comment"># curl http://192.168.10.12:30001</span></span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-2</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">bogon</span> ~]<span class="comment"># curl http://192.168.10.13:30001</span></span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-1</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">bogon</span> ~]<span class="comment"># curl http://192.168.10.14:30001</span></span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-1</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">bogon</span> ~]<span class="comment"># curl http://192.168.10.15:30001</span></span><br><span class="line">nginx<span class="literal">-app</span><span class="literal">-2</span></span><br></pre></td></tr></table></figure>



<h2 id="4-3-LoadBalancer"><a href="#4-3-LoadBalancer" class="headerlink" title="4.3 LoadBalancer"></a>4.3 LoadBalancer</h2><h3 id="4-3-1-集群外访问过程"><a href="#4-3-1-集群外访问过程" class="headerlink" title="4.3.1 集群外访问过程"></a>4.3.1 集群外访问过程</h3><ul>
<li><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4></li>
<li><h4 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h4></li>
<li><h4 id="云服务提供商提供LB服务"><a href="#云服务提供商提供LB服务" class="headerlink" title="云服务提供商提供LB服务"></a>云服务提供商提供LB服务</h4></li>
<li><h4 id="NodeIP-Port-service-IP"><a href="#NodeIP-Port-service-IP" class="headerlink" title="NodeIP:Port(service IP)"></a>NodeIP:Port(service IP)</h4></li>
<li><h4 id="Pod-IP：端口"><a href="#Pod-IP：端口" class="headerlink" title="Pod IP：端口"></a>Pod IP：端口</h4></li>
</ul>
<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20200531203510735.png" alt="image-20200531203510735"></p>
<h3 id="4-3-2-自建Kubernetes的LoadBalancer类型服务方案-MetalLB"><a href="#4-3-2-自建Kubernetes的LoadBalancer类型服务方案-MetalLB" class="headerlink" title="4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB"></a>4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB</h3><p>MetalLB可以为kubernetes集群中的Service提供网络负载均衡功能。</p>
<p>MetalLB两大功能为:</p>
<ul>
<li>地址分配，类似于DHCP</li>
<li>外部通告，一旦MetalLB为服务分配了外部IP地址，它就需要使群集之外的网络意识到该IP在群集中“存在”。MetalLB使用标准路由协议来实现此目的：ARP，NDP或BGP。</li>
</ul>
<h4 id="4-3-2-1-参考资料"><a href="#4-3-2-1-参考资料" class="headerlink" title="4.3.2.1  参考资料"></a>4.3.2.1  参考资料</h4><p>参考网址： <a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></p>
<h4 id="4-3-2-2-应用资源清单文件"><a href="#4-3-2-2-应用资源清单文件" class="headerlink" title="4.3.2.2  应用资源清单文件"></a>4.3.2.2  应用资源清单文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">资源清单文件下载：</span><br><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml</span></span><br></pre></td></tr></table></figure>



<h4 id="4-3-2-3-准备metallb配置文件"><a href="#4-3-2-3-准备metallb配置文件" class="headerlink" title="4.3.2.3 准备metallb配置文件"></a>4.3.2.3 准备metallb配置文件</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">nginx</span> <span class="type">metallb</span>]<span class="comment"># cat metallb-conf.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb<span class="literal">-system</span></span><br><span class="line">  name: config</span><br><span class="line"><span class="keyword">data</span>:</span><br><span class="line">  config: |</span><br><span class="line">    address<span class="literal">-pools</span>:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - <span class="number">192.168</span>.<span class="number">10.90</span><span class="literal">-192</span>.<span class="number">168.10</span>.<span class="number">100</span></span><br><span class="line"> </span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.90</span><span class="literal">-192</span>.<span class="number">168.10</span>.<span class="number">100</span>是集群节点服务器IP同一段。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在master01节点应用资源清单文件</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f metallb-conf.yaml	</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">验证配置</span><br><span class="line"><span class="comment"># kubectl describe configmap config -n metallb-system</span></span><br><span class="line">Name:         config</span><br><span class="line">Namespace:    metallb<span class="literal">-system</span></span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Data</span></span><br><span class="line">====</span><br><span class="line">config:</span><br><span class="line">----</span><br><span class="line">address<span class="literal">-pools</span>:</span><br><span class="line">- name: default</span><br><span class="line">  protocol: layer2</span><br><span class="line">  addresses:</span><br><span class="line">  - <span class="number">192.168</span>.<span class="number">10.90</span><span class="literal">-192</span>.<span class="number">168.10</span>.<span class="number">100</span></span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>





<h4 id="4-3-2-4发布Service类型为LoadBalancer的Deployment控制器类型应用"><a href="#4-3-2-4发布Service类型为LoadBalancer的Deployment控制器类型应用" class="headerlink" title="4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用"></a>4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">创建Deployment控制器类型应用nginx<span class="literal">-metallb</span>及service，service类型为LoadBalancer</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># vim 02_nginx-metabllb.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-metallb</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx<span class="literal">-metallb1</span></span><br><span class="line">        image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-metallb</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">8090</span></span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: <span class="number">80</span></span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  </span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f nginx.yaml</span></span><br></pre></td></tr></table></figure>



<h4 id="4-3-2-5-验证"><a href="#4-3-2-5-验证" class="headerlink" title="4.3.2.5 验证"></a>4.3.2.5 验证</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get ns</span></span><br><span class="line">NAME                   STATUS   AGE</span><br><span class="line">default                Active   <span class="number">16</span>d</span><br><span class="line">kube<span class="literal">-node</span><span class="literal">-lease</span>        Active   <span class="number">16</span>d</span><br><span class="line">kube<span class="literal">-public</span>            Active   <span class="number">16</span>d</span><br><span class="line">kube<span class="literal">-system</span>            Active   <span class="number">16</span>d</span><br><span class="line">kubernetes<span class="literal">-dashboard</span>   Active   <span class="number">13</span>d</span><br><span class="line">metallb<span class="literal">-system</span>         Active   <span class="number">130</span>m</span><br><span class="line">test1                  Active   <span class="number">12</span>d</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -n metallb-system</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">controller<span class="literal">-64f8f944d</span><span class="literal">-qdf8m</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">110</span>m</span><br><span class="line">speaker<span class="literal">-cwzq7</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">110</span>m</span><br><span class="line">speaker<span class="literal">-qk5fb</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">110</span>m</span><br><span class="line">speaker<span class="literal">-wsllb</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">110</span>m</span><br><span class="line">speaker<span class="literal">-x4bwt</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">110</span>m</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME            <span class="built_in">TYPE</span>           CLUSTER<span class="literal">-IP</span>      EXTERNAL<span class="literal">-IP</span>      PORT(S)          AGE</span><br><span class="line">kubernetes      ClusterIP      <span class="number">10.96</span>.<span class="number">0.1</span>       &lt;none&gt;           <span class="number">443</span>/TCP          <span class="number">16</span>d</span><br><span class="line">nginx<span class="literal">-metallb</span>   LoadBalancer   <span class="number">10.105</span>.<span class="number">239.69</span>   <span class="number">192.168</span>.<span class="number">10.90</span>   <span class="number">8090</span>:<span class="number">31372</span>/TCP   <span class="number">106</span>m</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># ping 192.168.10.90</span></span><br><span class="line">PING <span class="number">192.168</span>.<span class="number">10.90</span> (<span class="number">192.168</span>.<span class="number">10.90</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of <span class="keyword">data</span>.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">10.90</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">3.45</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">192.168</span>.<span class="number">10.90</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.040</span> ms</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-6-访问"><a href="#4-3-2-6-访问" class="headerlink" title="4.3.2.6 访问"></a>4.3.2.6 访问</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl http://192.168.122.90:8090</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: <span class="number">35</span>em;</span><br><span class="line">        margin: <span class="number">0</span> auto;</span><br><span class="line">        font<span class="literal">-family</span>: Tahoma, Verdana, Arial, sans<span class="literal">-serif</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;<span class="keyword">If</span> you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;<span class="keyword">For</span> online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> <span class="keyword">using</span> nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p><img src="/images/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service.assets/image-20220402101421824.png" alt="image-20220402101421824"></p>
<p><strong>注意：使用kubeadm部署kubernetes集群修改方法</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">如果在IPVS模式下使用kube<span class="literal">-proxy</span>，从Kubernetes v1.<span class="number">14.2</span>开始，必须启用ARP模式。</span><br><span class="line"></span><br><span class="line">可以通过在当前集群中编辑kube<span class="literal">-proxy</span>配置来实现：</span><br><span class="line"><span class="comment"># kubectl edit configmap -n kube-system kube-proxy</span></span><br><span class="line"></span><br><span class="line">并设置：</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line">ipvs:</span><br><span class="line">  strictARP: true</span><br></pre></td></tr></table></figure>



<h2 id="4-4-ExternalName"><a href="#4-4-ExternalName" class="headerlink" title="4.4 ExternalName"></a>4.4 ExternalName</h2><h3 id="4-4-1-ExternalName作用"><a href="#4-4-1-ExternalName作用" class="headerlink" title="4.4.1 ExternalName作用"></a>4.4.1 ExternalName作用</h3><ul>
<li>把集群外部的服务引入到集群内部中来，实现了集群内部pod和集群外部的服务进行通信</li>
<li>ExternalName 类型的服务适用于外部服务使用域名的方式，缺点是不能指定端口</li>
<li>还有一点要注意: 集群内的Pod会继承Node上的DNS解析规则。所以只要Node可以访问的服务，Pod中也可以访问到, 这就实现了集群内服务访问集群外服务</li>
</ul>
<h3 id="4-4-2-将公网域名引入"><a href="#4-4-2-将公网域名引入" class="headerlink" title="4.4.2   将公网域名引入"></a>4.4.2   将公网域名引入</h3><p>1, 编写YAML文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># vim externelname.yml</span></span><br><span class="line"> </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my<span class="literal">-externalname</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: www.baidu.com                  <span class="comment"># 对应的外部域名为www.baidu.com</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>2, 应用YAML文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f externelname.yml</span></span><br><span class="line">service/my<span class="literal">-externalname</span> created</span><br></pre></td></tr></table></figure>

<p>3, 查看service</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get svc |grep exter</span></span><br><span class="line">my<span class="literal">-externalname</span>    ExternalName   &lt;none&gt;         www.baidu.com   &lt;none&gt;         <span class="number">69</span>s</span><br></pre></td></tr></table></figure>



<p>4, 查看my-service的dns解析</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># dig -t A my-externalname.default.svc.cluster.local. @10.96.0.2</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG <span class="number">9.9</span>.<span class="number">4</span><span class="literal">-RedHat</span><span class="literal">-9</span>.<span class="number">9.4</span><span class="literal">-72</span>.el7 &lt;&lt;&gt;&gt; <span class="literal">-t</span> A my<span class="literal">-externalname</span>.default.svc.cluster.local. @<span class="number">10.2</span>.<span class="number">0.2</span></span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: <span class="number">31378</span></span><br><span class="line">;; flags: qr aa <span class="built_in">rd</span>; QUERY: <span class="number">1</span>, ANSWER: <span class="number">4</span>, AUTHORITY: <span class="number">0</span>, ADDITIONAL: <span class="number">1</span></span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: <span class="number">0</span>, flags:; udp: <span class="number">4096</span></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;my<span class="literal">-externalname</span>.default.svc.cluster.local. <span class="keyword">IN</span> A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">my<span class="literal">-externalname</span>.default.svc.cluster.local. <span class="number">5</span> <span class="keyword">IN</span> CNAME www.baidu.com.</span><br><span class="line">www.baidu.com.          <span class="number">5</span>       <span class="keyword">IN</span>      CNAME   www.a.shifen.com.</span><br><span class="line">www.a.shifen.com.       <span class="number">5</span>       <span class="keyword">IN</span>      A       <span class="number">14.215</span>.<span class="number">177.38</span>           解析的是百度的IP</span><br><span class="line">www.a.shifen.com.       <span class="number">5</span>       <span class="keyword">IN</span>      A       <span class="number">14.215</span>.<span class="number">177.39</span>           解析的是百度的IP</span><br><span class="line"></span><br><span class="line">;; Query time: <span class="number">32</span> msec</span><br><span class="line">;; SERVER: <span class="number">10.2</span>.<span class="number">0.2</span><span class="comment">#53(10.96.0.2)</span></span><br><span class="line">;; WHEN: Thu Nov <span class="number">05</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">41</span> CST <span class="number">2020</span></span><br><span class="line">;; MSG SIZE  rcvd: <span class="number">245</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it deploy-nginx-6c9764bb69-86gwj -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># nslookup www.baidu.com</span></span><br><span class="line">......</span><br><span class="line">Name:      www.baidu.com</span><br><span class="line">Address <span class="number">1</span>: <span class="number">14.215</span>.<span class="number">177.39</span></span><br><span class="line">Address <span class="number">2</span>: <span class="number">14.215</span>.<span class="number">177.38</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup my-externalname.default.svc.cluster.local         </span></span><br><span class="line">......</span><br><span class="line">Name:      my<span class="literal">-externalname</span>.default.svc.cluster.local</span><br><span class="line">Address <span class="number">1</span>: <span class="number">14.215</span>.<span class="number">177.38</span></span><br><span class="line">Address <span class="number">2</span>: <span class="number">14.215</span>.<span class="number">177.39</span></span><br></pre></td></tr></table></figure>

<p>解析此<code>my-externalname.default.svc.cluster.local</code>域名和解析<code>www.baidu.com</code>是一样的结果</p>
<h3 id="4-4-3-不同命名空间访问"><a href="#4-4-3-不同命名空间访问" class="headerlink" title="4.4.3 不同命名空间访问"></a>4.4.3 不同命名空间访问</h3><p>1， 创建ns1命名空间和相关deploy, pod,service</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># vim ns1-nginx.yml</span></span><br><span class="line">apiVersion: v1                                                  </span><br><span class="line">kind: Namespace                                                 </span><br><span class="line">metadata:                                                             </span><br><span class="line">  name: ns1                                                     <span class="comment"># 创建ns1命名空间</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">deploy-nginx</span>                    </span><br><span class="line">  namespace: ns1                                                <span class="comment"># 属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span>                                  </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx                                </span><br><span class="line">  template:                                        </span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx                             </span><br><span class="line">    spec:</span><br><span class="line">      containers:                              </span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: svc1                                <span class="comment"># 服务名</span></span><br><span class="line">  namespace: ns1                            <span class="comment"># 属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  clusterIP: None                           <span class="comment"># 无头service</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">80</span>                         </span><br><span class="line">    targetPort: <span class="number">80</span>                  </span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: external<span class="literal">-svc1</span></span><br><span class="line">  namespace: ns1                            <span class="comment">#  属于ns1命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: svc2.ns2.svc.cluster.local   <span class="comment"># 将ns2空间的svc2服务引入到ns1命名空间</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"> [<span class="type">root</span>@<span class="type">master1</span> ~]<span class="comment"># kubectl apply -f ns1-nginx.yml</span></span><br><span class="line"> namespace/ns1 created</span><br><span class="line"> deployment.apps/<span class="built_in">deploy-nginx</span> created</span><br><span class="line"> service/svc1 created</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<p>2， 创建ns2命名空间和相关deploy, pod,service</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># vim ns1-nginx.yml</span></span><br><span class="line">apiVersion: v1                                                  </span><br><span class="line">kind: Namespace                                                 </span><br><span class="line">metadata:                                                             </span><br><span class="line">  name: ns2                                                     <span class="comment"># 创建ns2命名空间</span></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">deploy-nginx</span>                    </span><br><span class="line">  namespace: ns2                                                <span class="comment"># 属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span>                                  </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx                                </span><br><span class="line">  template:                                        </span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx                             </span><br><span class="line">    spec:</span><br><span class="line">      containers:                              </span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: svc2                                <span class="comment"># 服务名</span></span><br><span class="line">  namespace: ns2                            <span class="comment"># 属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  clusterIP: None                           <span class="comment"># 无头service</span></span><br><span class="line">  ports:</span><br><span class="line">  - port: <span class="number">80</span>                         </span><br><span class="line">    targetPort: <span class="number">80</span>                  </span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: external<span class="literal">-svc1</span></span><br><span class="line">  namespace: ns2                            <span class="comment">#  属于ns2命名空间</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ExternalName</span><br><span class="line">  externalName: svc1.ns1.svc.cluster.local   <span class="comment"># 将ns1空间的svc1服务引入到ns2命名空间</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f ns2-nginx.yml</span></span><br><span class="line">namespace/ns2 created</span><br><span class="line">deployment.apps/<span class="built_in">deploy-nginx</span> created</span><br><span class="line">service/svc2 created</span><br><span class="line">service/external<span class="literal">-svc2</span> created</span><br></pre></td></tr></table></figure>



<p>3,  在ns1命名空间的pod里验证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -n ns1</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-g5xl8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">8</span>m10s</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># nslookup svc1</span></span><br><span class="line">......</span><br><span class="line">Name:      svc1</span><br><span class="line">Address <span class="number">1</span>: <span class="number">10.3</span>.<span class="number">166.140</span> <span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-g5xl8</span>       IP与ns1里的podIP一致(见下面的查询结果)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup svc2.ns2.svc.cluster.local</span></span><br><span class="line">.....</span><br><span class="line">Name:      svc2.ns2.svc.cluster.local</span><br><span class="line">Address <span class="number">1</span>: <span class="number">10.3</span>.<span class="number">104.17</span> <span class="number">10</span><span class="literal">-3</span><span class="literal">-104</span><span class="literal">-17</span>.svc2.ns2.svc.cluster.local   IP与ns2里的podIP一致(见下面的查询结果)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -o wide -n ns1</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE   IP             NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line"><span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-g5xl8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">70</span>m   <span class="number">10.3</span>.<span class="number">166.140</span>   <span class="number">192.168</span>.<span class="number">122.13</span>   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -o wide -n ns2</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READI            NESS GATES</span><br><span class="line"><span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-8psxl</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">68</span>m   <span class="number">10.3</span>.<span class="number">104.17</span>   <span class="number">192.168</span>.<span class="number">122.14</span>   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>反之，在ns2命名空间的pod里访问<code>svc1.ns1.svc.cluster.local</code>，解析的IP是ns1命名空间里的pod的IP(请自行验证)</p>
<p>4， 验证ns2中的pod的IP变化, ns1中的pod仍然可以使用<code>svc2.ns2.svc.cluster.local</code>访问</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pod -n ns2</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-8psxl</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">81</span>m</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl delete pod deploy-nginx-6c9764bb69-8psxl -n ns2</span></span><br><span class="line">pod <span class="string">&quot;deploy-nginx-6c9764bb69-8psxl&quot;</span> deleted                   因为有replicas控制器，所以删除pod会自动拉一个起来</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pod -o wide -n ns2</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP             NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line"><span class="built_in">deploy-nginx</span><span class="literal">-6c9764bb69</span><span class="literal">-8qbz2</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m36s   <span class="number">10.3</span>.<span class="number">166.141</span>   <span class="number">192.168</span>.<span class="number">122.13</span>   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">pod名称变了,IP也变成了<span class="number">10.3</span>.<span class="number">166.141</span></span><br></pre></td></tr></table></figure>

<p>回到ns1中的pod验证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping svc2.ns2.svc.cluster.local -c 2</span></span><br><span class="line">PING svc2.ns2.svc.cluster.local (<span class="number">10.3</span>.<span class="number">166.141</span>): <span class="number">56</span> <span class="keyword">data</span> bytes    解析的IP就是ns2中pod的新IP</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.3</span>.<span class="number">166.141</span>: seq=<span class="number">0</span> ttl=<span class="number">63</span> time=<span class="number">0.181</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.3</span>.<span class="number">166.141</span>: seq=<span class="number">1</span> ttl=<span class="number">63</span> time=<span class="number">0.186</span> ms</span><br><span class="line"></span><br><span class="line">--- svc2.ns2.svc.cluster.local ping statistics ---</span><br><span class="line"><span class="number">2</span> packets transmitted, <span class="number">2</span> packets received, <span class="number">0</span>% packet loss</span><br><span class="line">round<span class="literal">-trip</span> min/avg/max = <span class="number">0.181</span>/<span class="number">0.183</span>/<span class="number">0.186</span> ms</span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="五、sessionAffinity"><a href="#五、sessionAffinity" class="headerlink" title="五、sessionAffinity"></a>五、sessionAffinity</h1><blockquote>
<p>会话粘贴</p>
</blockquote>
<p>设置sessionAffinity为Clientip  (类似nginx的ip_hash算法,lvs的sh算法)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">nginx</span> ~]<span class="comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-server1</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">2</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">     metadata:</span><br><span class="line">       labels:</span><br><span class="line">         app: nginx</span><br><span class="line">     spec:</span><br><span class="line">       containers:</span><br><span class="line">       - name: c1</span><br><span class="line">         image: nginx:<span class="number">1.15</span><span class="literal">-alpine</span></span><br><span class="line">         imagePullPolicy: IfNotPresent</span><br><span class="line">         ports:</span><br><span class="line">         - containerPort: <span class="number">80</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-svc</span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: <span class="number">80</span></span><br><span class="line">    targetPort: <span class="number">80</span></span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f 02_create_deployment_app_nginx_with_service.yaml</span></span><br><span class="line">deployment.apps/nginx<span class="literal">-server1</span> created</span><br><span class="line">service/nginx<span class="literal">-svc</span> created</span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-9zlnw</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m11s</span><br><span class="line">nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-ffqdt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m11s</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-server1-58845f75f4-9zlnw bash</span></span><br><span class="line">kubectl exec [<span class="type">POD</span>] [<span class="type">COMMAND</span>] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl kubectl exec [<span class="type">POD</span>] -- [<span class="type">COMMAND</span>] instead.</span><br><span class="line">root@nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-9zlnw</span>:/<span class="comment"># echo web1 &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-9zlnw</span>:/<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl exec -it nginx-server1-58845f75f4-ffqdt bash</span></span><br><span class="line">kubectl exec [<span class="type">POD</span>] [<span class="type">COMMAND</span>] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl kubectl exec [<span class="type">POD</span>] -- [<span class="type">COMMAND</span>] instead.</span><br><span class="line">root@nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-ffqdt</span>:/<span class="comment"># echo web2 &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line">root@nginx<span class="literal">-server1</span><span class="literal">-58845f75f4</span><span class="literal">-ffqdt</span>:/<span class="comment"># exit</span></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         <span class="built_in">TYPE</span>        CLUSTER<span class="literal">-IP</span>     EXTERNAL<span class="literal">-IP</span>   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>      &lt;none&gt;        <span class="number">443</span>/TCP   <span class="number">16</span>d</span><br><span class="line">nginx<span class="literal">-svc</span>    ClusterIP   <span class="number">10.100</span>.<span class="number">53.31</span>   &lt;none&gt;        <span class="number">80</span>/TCP    <span class="number">3</span>m53s</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl http://10.100.53.31</span></span><br><span class="line">web1</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl http://10.100.53.31</span></span><br><span class="line">web2</span><br><span class="line">或</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># while true;do curl 10.100.53.31;sleep 1; done</span></span><br></pre></td></tr></table></figure>





<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl patch svc nginx-svc -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;sessionAffinity&quot;:&quot;ClientIP&quot;&#125;&#125;&#x27;</span></span><br><span class="line">service/nginx<span class="literal">-svc</span> patched</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl 10.100.53.31</span></span><br><span class="line">web1</span><br><span class="line">多次访问,会话粘贴</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置回sessionAffinity为None</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl patch svc nginx-svc -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;sessionAffinity&quot;:&quot;None&quot;&#125;&#125;&#x27;</span></span><br><span class="line">service/my<span class="literal">-service</span> patched</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">测试</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl 10.100.53.31</span></span><br><span class="line">web1</span><br><span class="line">多次访问,回到负载均衡</span><br><span class="line">或</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># while true;do curl 10.100.53.31;sleep 1; done</span></span><br><span class="line">web1</span><br><span class="line">多次访问,会话粘贴</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="六、修改为ipvs调度方式（拓展）"><a href="#六、修改为ipvs调度方式（拓展）" class="headerlink" title="六、修改为ipvs调度方式（拓展）"></a>六、修改为ipvs调度方式（拓展）</h1><blockquote>
<p>部署方式不同，修改方法不一样。</p>
<p>本次主要介绍使用kubeadm部署集群方式，二进制部署较为简单。</p>
<p>二进制部署修改：/etc/kubernetes/kube-proxy.yaml文件即可。</p>
</blockquote>
<p>从kubernetes1.8版本开始，新增了kube-proxy对ipvs的支持，在kubernetes1.11版本中被纳入了GA.</p>
<h2 id="6-1-修改为IPVS调度方式前升级内核"><a href="#6-1-修改为IPVS调度方式前升级内核" class="headerlink" title="6.1 修改为IPVS调度方式前升级内核"></a>6.1 修改为IPVS调度方式前升级内核</h2><blockquote>
<p>现使用Centos7u6发布版本，默认内核版本为3.10.0，使用kubernetes为1.18.0时，可升级内核版本至4.18.0或5.6.0版本。</p>
</blockquote>
<blockquote>
<p>在所有节点中安装,需要重启操作系统更换内核。以下升级方法供参考。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum -y install perl</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># yum  --enablerepo=&quot;elrepo-kernel&quot;  -y install kernel-ml.x86_64 </span></span><br><span class="line">此处升级为<span class="number">5.0</span>以上版本。</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># grub2-set-default 0</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>





<h2 id="6-2-修改kube-proxy的配置文件"><a href="#6-2-修改kube-proxy的配置文件" class="headerlink" title="6.2 修改kube-proxy的配置文件"></a>6.2 修改kube-proxy的配置文件</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl edit configmap kube-proxy -n kube-system</span></span><br><span class="line">     <span class="number">26</span>     iptables:</span><br><span class="line">     <span class="number">27</span>       masqueradeAll: false</span><br><span class="line">     <span class="number">28</span>       masqueradeBit: <span class="number">14</span></span><br><span class="line">     <span class="number">29</span>       minSyncPeriod: <span class="number">0</span>s</span><br><span class="line">     <span class="number">30</span>       syncPeriod: <span class="number">30</span>s</span><br><span class="line">     <span class="number">31</span>     ipvs:</span><br><span class="line">     <span class="number">32</span>       excludeCIDRs: null</span><br><span class="line">     <span class="number">33</span>       minSyncPeriod: <span class="number">0</span>s</span><br><span class="line">     <span class="number">34</span>       scheduler: <span class="string">&quot;&quot;</span>	  <span class="comment"># 可以在这里修改ipvs的算法,默认为rr轮循算法</span></span><br><span class="line">     <span class="number">35</span>       strictARP: false</span><br><span class="line">     <span class="number">36</span>       syncPeriod: <span class="number">30</span>s</span><br><span class="line">     <span class="number">37</span>     kind: KubeProxyConfiguration</span><br><span class="line">     <span class="number">38</span>     metricsBindAddress: <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">10249</span></span><br><span class="line">     <span class="number">39</span>     mode: <span class="string">&quot;ipvs&quot;</span>	  <span class="comment"># 默认&quot;&quot;号里为空,加上ipvs</span></span><br></pre></td></tr></table></figure>



<h2 id="6-3-查看kube-system的namespace中kube-proxy有关的pod"><a href="#6-3-查看kube-system的namespace中kube-proxy有关的pod" class="headerlink" title="6.3  查看kube-system的namespace中kube-proxy有关的pod"></a>6.3  查看kube-system的namespace中kube-proxy有关的pod</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -n kube-system |grep kube-proxy</span></span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-69mv6</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">6</span>          <span class="number">2</span>d18<span class="built_in">h</span></span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-jpc6c</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">4</span>          <span class="number">4</span>d16<span class="built_in">h</span></span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-kq65l</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">4</span>          <span class="number">4</span>d16<span class="built_in">h</span></span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-lmphf</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">5</span>          <span class="number">4</span>d16<span class="built_in">h</span></span><br></pre></td></tr></table></figure>



<h2 id="6-4-验证kube-proxy-xxx的pod中的信息"><a href="#6-4-验证kube-proxy-xxx的pod中的信息" class="headerlink" title="6.4 验证kube-proxy-xxx的pod中的信息"></a>6.4 验证kube-proxy-xxx的pod中的信息</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl logs kube-proxy-jpc6c -n kube-system</span></span><br><span class="line">W0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.914754</span>       <span class="number">1</span> server_others.go:<span class="number">559</span>] Unknown proxy mode <span class="string">&quot;&quot;</span>, assuming iptables proxy</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.923228</span>       <span class="number">1</span> node.go:<span class="number">136</span>] Successfully retrieved node IP: <span class="number">192.168</span>.<span class="number">122.32</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.923264</span>       <span class="number">1</span> server_others.go:<span class="number">186</span>] <span class="keyword">Using</span> iptables Proxier.</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.923567</span>       <span class="number">1</span> server.go:<span class="number">583</span>] Version: v1.<span class="number">18.2</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.923965</span>       <span class="number">1</span> conntrack.go:<span class="number">100</span>] <span class="built_in">Set</span> sysctl <span class="string">&#x27;net/netfilter/nf_conntrack_max&#x27;</span> to <span class="number">131072</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.924001</span>       <span class="number">1</span> conntrack.go:<span class="number">52</span>] Setting nf_conntrack_max to <span class="number">131072</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.924258</span>       <span class="number">1</span> conntrack.go:<span class="number">83</span>] Setting conntrack hashsize to <span class="number">32768</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927041</span>       <span class="number">1</span> conntrack.go:<span class="number">100</span>] <span class="built_in">Set</span> sysctl <span class="string">&#x27;net/netfilter/nf_conntrack_tcp_timeout_established&#x27;</span> to <span class="number">86400</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927086</span>       <span class="number">1</span> conntrack.go:<span class="number">100</span>] <span class="built_in">Set</span> sysctl <span class="string">&#x27;net/netfilter/nf_conntrack_tcp_timeout_close_wait&#x27;</span> to <span class="number">3600</span></span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927540</span>       <span class="number">1</span> config.go:<span class="number">315</span>] Starting service config controller</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927556</span>       <span class="number">1</span> shared_informer.go:<span class="number">223</span>] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927576</span>       <span class="number">1</span> config.go:<span class="number">133</span>] Starting endpoints config controller</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">10.927594</span>       <span class="number">1</span> shared_informer.go:<span class="number">223</span>] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">11.027749</span>       <span class="number">1</span> shared_informer.go:<span class="number">230</span>] Caches are synced <span class="keyword">for</span> service config</span><br><span class="line">I0517 <span class="number">00</span>:<span class="number">55</span>:<span class="number">11.027858</span>       <span class="number">1</span> shared_informer.go:<span class="number">230</span>] Caches are synced <span class="keyword">for</span> endpoints config</span><br></pre></td></tr></table></figure>



<h2 id="6-5-重新启动kube-proxy"><a href="#6-5-重新启动kube-proxy" class="headerlink" title="6.5 重新启动kube-proxy"></a>6.5 重新启动kube-proxy</h2><blockquote>
<p>删除kube-proxy-xxx的所有pod，让它重新拉取新的kube-proxy-xxx的pod</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl delete pod kube-proxy-69mv6 -n kube-system</span></span><br><span class="line">pod <span class="string">&quot;kube-proxy-69mv6&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl delete pod kube-proxy-jpc6c -n kube-system</span></span><br><span class="line">pod <span class="string">&quot;kube-proxy-jpc6c&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl delete pod kube-proxy-kq65l -n kube-system</span></span><br><span class="line">pod <span class="string">&quot;kube-proxy-kq65l&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl delete pod kube-proxy-lmphf -n kube-system</span></span><br><span class="line">pod <span class="string">&quot;kube-proxy-lmphf&quot;</span> deleted</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -n kube-system |grep kube-proxy</span></span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-2mk2b</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m23s</span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-5bj87</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>s</span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-7qq9l</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">52</span>s</span><br><span class="line">kube<span class="literal">-proxy</span><span class="literal">-tjtqf</span>                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">80</span>s</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">随意查看其中<span class="number">1</span>个或<span class="number">3</span>个kube<span class="literal">-proxy</span><span class="literal">-xxx</span>的pod,验证是否为IPVS方式了</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master1</span> ~]<span class="comment"># kubectl logs kube-proxy-tjtqf -n kube-system</span></span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.557696</span>       <span class="number">1</span> node.go:<span class="number">136</span>] Successfully retrieved node IP: <span class="number">192.168</span>.<span class="number">122.32</span></span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.557745</span>       <span class="number">1</span> server_others.go:<span class="number">259</span>] <span class="keyword">Using</span> ipvs Proxier.</span><br><span class="line">W0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.557912</span>       <span class="number">1</span> proxier.go:<span class="number">429</span>] IPVS scheduler not specified, use rr by default</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.560008</span>       <span class="number">1</span> server.go:<span class="number">583</span>] Version: v1.<span class="number">18.2</span></span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.560428</span>       <span class="number">1</span> conntrack.go:<span class="number">52</span>] Setting nf_conntrack_max to <span class="number">131072</span></span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.561094</span>       <span class="number">1</span> config.go:<span class="number">315</span>] Starting service config controller</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.562251</span>       <span class="number">1</span> shared_informer.go:<span class="number">223</span>] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.561579</span>       <span class="number">1</span> config.go:<span class="number">133</span>] Starting endpoints config controller</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.562271</span>       <span class="number">1</span> shared_informer.go:<span class="number">223</span>] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.662541</span>       <span class="number">1</span> shared_informer.go:<span class="number">230</span>] Caches are synced <span class="keyword">for</span> service config</span><br><span class="line">I0517 <span class="number">02</span>:<span class="number">32</span>:<span class="number">26.662566</span>       <span class="number">1</span> shared_informer.go:<span class="number">230</span>] Caches are synced <span class="keyword">for</span> endpoints config</span><br></pre></td></tr></table></figure>






  </div>
</article>





    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>  
    <div id="vcomments" class="blog-post-comments"></div>
    <script>        
        new Valine({
            el: '#vcomments',
            visitor: true,
            appId: 'gqmHGHyrnzRPUSxqADLhUzlT-gzGzoHsz',
            appKey: 'q8uQ7rKeukTuQ3L35peaOhkC',
            placeholder: '好哥哥，说几句吧！',
            avatar: 'retro'
        })
    </script>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81-service%E4%BD%9C%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">一、 service作用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81kube-proxy%E4%B8%89%E7%A7%8D%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">二、kube-proxy三种代理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-UserSpace%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 UserSpace模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-iptables%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 iptables模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-ipvs%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 ipvs模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-iptables%E4%B8%8Eipvs%E5%AF%B9%E6%AF%94"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 iptables与ipvs对比</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81-service%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">三、 service类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-service%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 service类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Service%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Service参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-Service%E5%88%9B%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">四、 Service创建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ClusterIP%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ClusterIP类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E6%99%AE%E9%80%9AClusterIP-Service%E5%88%9B%E5%BB%BA"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 普通ClusterIP Service创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-1-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%9B%E5%BB%BAService"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">4.1.1.1 命令行创建Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-2-%E9%80%9A%E8%BF%87%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAService"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">4.1.1.2 通过资源清单文件创建Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-3-%E8%AE%BF%E9%97%AE"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">4.1.1.3 访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-4-%E4%B8%A4%E4%B8%AApod%E9%87%8C%E5%81%9A%E6%88%90%E4%B8%8D%E5%90%8C%E7%9A%84%E4%B8%BB%E9%A1%B5%E6%96%B9%E4%BE%BF%E6%B5%8B%E8%AF%95%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.1.1.4.</span> <span class="toc-text">4.1.1.4 两个pod里做成不同的主页方便测试负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.1.5.</span> <span class="toc-text">4.1.1.5 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-Headless-Service"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 Headless Service</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-1-%E7%BC%96%E5%86%99%E7%94%A8%E4%BA%8E%E5%88%9B%E5%BB%BADeployment%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-2-%E9%80%9A%E8%BF%87%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAheadless-Service"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">4.1.2.2 通过资源清单文件创建headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-3-%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAheadless-Service"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">4.1.2.3 应用资源清单文件创建headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-4-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%88%9B%E5%BB%BA%E7%9A%84headless-Service"><span class="toc-number">4.1.2.4.</span> <span class="toc-text">4.1.2.4 查看已创建的headless Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-5-DNS"><span class="toc-number">4.1.2.5.</span> <span class="toc-text">4.1.2.5 DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-1-%E6%9F%A5%E7%9C%8Bkube-dns%E6%9C%8D%E5%8A%A1%E7%9A%84IP"><span class="toc-number">4.1.2.5.1.</span> <span class="toc-text">4.1.2.5.1 查看kube-dns服务的IP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-2-%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87DNS%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E6%9F%A5%E6%89%BE%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E7%9A%84dns%E8%A7%A3%E6%9E%90"><span class="toc-number">4.1.2.5.2.</span> <span class="toc-text">4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-3-%E9%AA%8C%E8%AF%81pod%E7%9A%84IP"><span class="toc-number">4.1.2.5.3.</span> <span class="toc-text">4.1.2.5.3  验证pod的IP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-5-4-%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApod%E9%AA%8C%E8%AF%81"><span class="toc-number">4.1.2.5.4.</span> <span class="toc-text">4.1.2.5.4 在集群中创建一个pod验证</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-NodePort%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 NodePort类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-LoadBalancer"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 LoadBalancer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E9%9B%86%E7%BE%A4%E5%A4%96%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 集群外访问过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E5%95%86%E6%8F%90%E4%BE%9BLB%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">云服务提供商提供LB服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodeIP-Port-service-IP"><span class="toc-number">4.3.1.4.</span> <span class="toc-text">NodeIP:Port(service IP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod-IP%EF%BC%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">4.3.1.5.</span> <span class="toc-text">Pod IP：端口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E8%87%AA%E5%BB%BAKubernetes%E7%9A%84LoadBalancer%E7%B1%BB%E5%9E%8B%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%A1%88-MetalLB"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-1-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">4.3.2.1  参考资料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-2-%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">4.3.2.2  应用资源清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-3-%E5%87%86%E5%A4%87metallb%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.3.</span> <span class="toc-text">4.3.2.3 准备metallb配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-4%E5%8F%91%E5%B8%83Service%E7%B1%BB%E5%9E%8B%E4%B8%BALoadBalancer%E7%9A%84Deployment%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-number">4.3.2.4.</span> <span class="toc-text">4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-5-%E9%AA%8C%E8%AF%81"><span class="toc-number">4.3.2.5.</span> <span class="toc-text">4.3.2.5 验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-6-%E8%AE%BF%E9%97%AE"><span class="toc-number">4.3.2.6.</span> <span class="toc-text">4.3.2.6 访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-ExternalName"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 ExternalName</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-ExternalName%E4%BD%9C%E7%94%A8"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 ExternalName作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E5%B0%86%E5%85%AC%E7%BD%91%E5%9F%9F%E5%90%8D%E5%BC%95%E5%85%A5"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.4.2   将公网域名引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E4%B8%8D%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.4.3 不同命名空间访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81sessionAffinity"><span class="toc-number">5.</span> <span class="toc-text">五、sessionAffinity</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BF%AE%E6%94%B9%E4%B8%BAipvs%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F%EF%BC%88%E6%8B%93%E5%B1%95%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">六、修改为ipvs调度方式（拓展）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BF%AE%E6%94%B9%E4%B8%BAIPVS%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F%E5%89%8D%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 修改为IPVS调度方式前升级内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BF%AE%E6%94%B9kube-proxy%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 修改kube-proxy的配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%9F%A5%E7%9C%8Bkube-system%E7%9A%84namespace%E4%B8%ADkube-proxy%E6%9C%89%E5%85%B3%E7%9A%84pod"><span class="toc-number">6.3.</span> <span class="toc-text">6.3  查看kube-system的namespace中kube-proxy有关的pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E9%AA%8C%E8%AF%81kube-proxy-xxx%E7%9A%84pod%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 验证kube-proxy-xxx的pod中的信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8kube-proxy"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 重新启动kube-proxy</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&text=kubernetes核心概念Service"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&is_video=false&description=kubernetes核心概念Service"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kubernetes核心概念Service&body=Check out this article: https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&title=kubernetes核心概念Service"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://fate-re-zero.github.io/2024/03/29/%E4%BA%91%E5%8E%9F%E7%94%9F/Kubernetes/kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5service/&name=kubernetes核心概念Service&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">2025 祥祥要起飞</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/lib/particles/particles.min.js"></script>


<script src="/lib/typing/typing.min.js"></script>


<script src="/js/main.js"></script>


<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


